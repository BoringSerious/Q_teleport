<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simulated Experiment</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      background-color: #2f4f78;
    }
    .tab {
      padding: 10px 20px;
      color: #333;
      background: #ccc;
      cursor: pointer;
    }
    .tab.active {
      background: #fff;
      font-weight: bold;
    }
    .container {
      display: none;
      height: calc(100% - 40px);
      padding: 10px;
      box-sizing: border-box;
    }
    .container.active {
      display: grid;
      /* grid-template-columns: 32% 34% 32%; */
      grid-template-columns: 32% 40% 28%; /* block2/4 wider, block3/6 narrower */
      grid-template-rows: 32% 32% 34%;
      gap: 5px;
      height: calc(100% - 40px);
      padding: 10px 20px 10px 10px; /* increase right margin */
      box-sizing: border-box;
      background: none;
    }
    .block {
      position: relative;
      border: 1px solid #ccc;
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.15), 0 1.5px 4px 0 rgba(0,0,0,0.10);
      min-height: 40px;
      box-sizing: border-box;
      overflow: hidden;
    }
    .block-yellow {
      background-color: #ffe9b3;
    }
    .btn-top-left, .btn-help {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: #0051ba;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      line-height: 20px;
      cursor: pointer;
    }
    .btn-top-left {
      top: 5px;
      left: 5px;
    }
    .btn-help {
      top: 5px;
      right: 5px;
      border-radius: 50%;
    }

    .block.hidden {
      display: none;
    }

    /* Define block sizes in percentages */
    .block-size-1 { width: 32%; height: 30%; }
    .block-size-2 { width: 32%; height: 30%; }
    .block-size-3 { width: 32%; height: 30%; }
    .block-size-4 { width: 32%; height: 30%; }
    .block-size-5 { width: 32%; height: 30%; }
    .block-size-6 { width: 98%; height: 30%; }

    .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }

    .column {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
    }
    .column-left {
      width: 32%;
    }
    .column-center {
      width: 32%;
    }
    .column-right {
      width: 32%;
    }
    .block-size-left-top {
      height: 60%;
    }
    .block-size-left-bottom {
      height: 38%;
    }
    .block-size-center-top {
      height: 30%;
    }
    .block-size-center-middle {
      height: 30%;
      margin: 10px 0;
    }
    .block-size-center-bottom {
      height: 38%;
    }
    .block-size-right-top {
      height: 48%;
    }
    .block-size-right-bottom {
      height: 48%;
    }
    .block {
      margin-bottom: 0;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      min-height: 40px;
      box-sizing: border-box;
    }
    .column > .block:not(:last-child) {
      margin-bottom: 2%;
    }

    /* Block position corresponds to image */
    #block0 { grid-column: 1 / 2; grid-row: 1 / 3; background-color: #fffff0; overflow-y: auto; }
    #block1 { grid-column: 1 / 2; grid-row: 3 / 4; background-color: #ffe9b3; }
    #block2 { grid-column: 2 / 3; grid-row: 1 / 2; background-color: #fffff0; }
    #block6 { grid-column: 2 / 3; grid-row: 2 / 3; background-color: #fffff0; }
    #block3 { grid-column: 3 / 4; grid-row: 1 / 2; background-color: #ffe9b3; }
    #block4 { grid-column: 3 / 4; grid-row: 2 / 3; background-color: #ffe9b3; }
    #block5 { grid-column: 2 / 4; grid-row: 3 / 4; background-color: #fffff0; }

    .block-label {
      position: absolute;
      top: 6px;
      left: 10px;
      background: rgba(255,255,255,0.85);
      color: #2f4f78;
      font-size: 15px;
      font-weight: bold;
      padding: 1px 8px;
      border-radius: 8px;
      z-index: 2;
      pointer-events: none;
    }

    .btn-bottom-right {
      position: absolute;
      right: 5px;
      bottom: 5px;
      width: 20px;
      height: 20px;
      background-color: #0051ba;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      line-height: 20px;
      cursor: pointer;
      border-radius: 3px;
      z-index: 2;
    }

    .block-content-hidden {
      display: none;
    }

    .restore-block-btn {
      width: 100%;
      height: 100%;
      min-height: 40px;
      background: #f5f7fa;
      color: #2f4f78;
      border: 2px dashed #2f4f78;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    #block6-block { background-color: #ffe9b3; }
    #block3-block { background-color: #ffe9b3; }

    .simple-slider-container {
      position: absolute;
      left: 18px;
      width: 66%;
      bottom: 18px;
      height: 32px;
      display: flex;
      align-items: flex-end;
      pointer-events: none;
    }
    .simple-slider-track {
      width: 100%;
      height: 4px;
      background: #4a5568;
      border-radius: 2px;
      position: relative;
      pointer-events: auto;
    }
    .simple-slider-thumb {
      position: absolute;
      top: 50%;
      left: 0%;
      width: 18px;
      height: 18px;
      background: #4e87d1;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transform: translate(-50%, -50%);
      cursor: pointer;
      z-index: 2;
      pointer-events: auto;
      transition: box-shadow 0.2s;
    }
    .simple-slider-thumb:active {
      box-shadow: 0 0 0 3px #b3d1f7;
    }

    .simple-slider-label {
      position: absolute;
      left: 18px;
      bottom: 56px;
      font-size: clamp(1em, 2.5vw, 2.2em);
      color: #2f4f78;
      font-weight: bold;
      background: rgba(255,255,255,0.7);
      padding: 2px 10px;
      border-radius: 8px;
      z-index: 3;
      pointer-events: none;
    }

    #block5, #block5 * {
      user-select: none !important;
    }

    /* Schrodinger picture styles from prototype.html */
    .grid {
      display: grid;
      grid-template-columns: repeat(11, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 0.2vw;
      width: 100%;
      margin: 0 0;
      margin-bottom: 50px;
    }
    .cell {
      width: 100%;
      height: auto;
      aspect-ratio: 1/1;
      background: #222;
      border: 1px solid #39382c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Quicksand', 'Arial Rounded MT Bold', 'Poppins', 'circular', 'Segoe UI Rounded', 'Segoe UI', 'Arial', sans-serif;
      font-weight: 700;
      transition: background 0.2s, color 0.2s, opacity 0.2s, font-size 0.2s;
      color: #c9b18a;
      opacity: 0.25;
      min-width: 0;
      min-height: 0;
      box-sizing: border-box;
    }
    .cell.gate { opacity: 1; color: #222; font-weight: bold; }
    .cell.gate.highlight {
      box-shadow: 0 0 18px 6px #fff, 0 0 0 2px #fff inset;
      color: #222;
      z-index: 2;
      font-size: 1.28em;
    }
    .cell.active {
      background: #6f5b3e;
      color: #fff7c9;
      opacity: 1;
      font-weight: bold;
    }
    .mini-cell-label {
      position: relative;
      width: 100%;
      max-width: 352px;
      min-width: 120px;
      height: auto;
      margin-top: 6px;
      margin-left: 0;
    }
    .mini-cell {
      /* width, height, font-size set dynamically by JS */
      background: #222;
      border: 1px solid #39382c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #c9b18a;
      font-weight: bold;
      position: absolute;
      top: 0;
      left: 0;
      /* transition: left 0.3s, width 0.2s, height 0.2s, font-size 0.2s; */
    }
    #state-sch {
      min-height: 2em;
      color: #6fd8fc;
      margin-bottom: 6px;
      font-size: 0.8em;
      font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
      line-height: 1.6;
      word-break: break-word;
      overflow-y: auto;
      overflow-x: auto;
      height: 100%;
      padding-right: 8px;
    }
    .invisible-cell {
      visibility: hidden;
    }
    #block2-schrodinger {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 30px 10px 20px 10px;
    }
    #block4-heisenberg {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 30px 10px 20px 10px;
      background: #fffff0;
    }
    #grid-hei .cell {
      background: #e0c2c0;
      border: 1px solid #948778;
      color: #2f4f78;
    }
    #grid-hei .cell.invisible-cell {
      visibility: hidden;
    }
    #block4-heisenberg .grid .cell:not(.gate) {
      background: #e0d6c0 !important;
      border: 1px solid #312a20;
      color: #2f4f78;
    }
    #block4-heisenberg .grid .cell.gate.highlight {
      box-shadow: 0 0 18px 6px rgba(255,255,255,0.3), 0 0 0 2px rgba(255,255,255,0.25) inset;
      color: #222;
      z-index: 2;
      font-size: 1.28em;
    }
    #block4-heisenberg .grid .cell.active-ut {
      background: #2d5ec7 !important;
      color: #fff !important;
      opacity: 1 !important;
      font-weight: bold;
      border: 1px solid #39382c;
      border-radius: 4px;
      font-size: clamp(0.9em, 1.5vw, 1.15em);
      transition: background 0.2s, color 0.2s, opacity 0.2s;
      z-index: 2;
    }
    .simple-slider-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2em;
      color: #2d5ec7;
      margin-left: 12px;
      user-select: none;
      width: 36px;
      height: 36px;
      line-height: 36px;
      pointer-events: auto;
    }
    .pauli-expect-block {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      margin-top: 10px;
      margin-bottom: 10px;
      gap: 10px;
      padding-left: 16px;
      padding-right: 16px;
    }
    .pauli-row {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      margin-bottom: 0;
    }
    .pauli-label {
      width: 2.5em;
      min-width: 2.5em;
      margin-left: 8px;
    }
    .pauli-box {
      flex: 1 1 0;
      min-width: 0;
      height: 28px;
      border: 1px solid #39382c;
      border-radius: 5px;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 0.98em;
      transition: background 0.2s;
    }
    #block1 {
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      height: 100%;
    }
    .pauli-expect-block {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      align-items: flex-start;
      height: 100%;
      margin: 0;
      gap: 0;
    }
    .pauli-row {
      margin-bottom: 0;
    }
    #block1 .block-label {
      margin-bottom: 0.8em;
      z-index: 1;
    }
    .pauli-expect-block {
      height: calc(100% - 2.5em);
    }
    #block3-quantum-state {
      width: 100%;
      overflow-wrap: break-word;
      word-break: break-all;
      margin-top: 32px;
      text-align: left !important;
    }
    #block3-quantum-state mjx-container {
      justify-content: flex-start !important;
      text-align: left !important;
    }
    #block6-descriptor {
      background: #ffe9b3;
      padding: 10px 10px;
      color: #222;
      margin-top: 24px;
    }
    #block6-descriptor .desc-state-row,
    #block6-descriptor .desc-label2,
    #block6-descriptor .desc-equal,
    #block6-descriptor .desc-op,
    #block6-descriptor .desc-comma {
      color: #222 !important;
    }
    #block6-descriptor .desc-state-row {
      font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
      font-size: 1.12em;
      color: #2f4f78;
      margin-bottom: 4px;
      line-height: 1.8;
      padding-left: 3px;
      justify-content: flex-start;
      align-items: center;
      display: flex;
      width: 100%;
    }
    #block6-descriptor .desc-s1 { color: #e6b800 !important; }
    #block6-descriptor .desc-s2 { color: deepskyblue !important; }
    #block6-descriptor .desc-s3 { color: magenta !important; }
    #block6-descriptor .desc-s4 { color: red !important; }

    /* Block 5 content cannot be selected */
    .block5-flex {
      display: flex;
      flex-direction: row;
      width: 100%;
      height: 100%;
      align-items: stretch;
    }
    .block5-main {
      flex: 1 1 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      margin-top: 20px;
    }
    .block7-properties {
      flex: 0 0 30%;
      min-width: 120px;
      max-width: 220px;
      background: #f5f7fa;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 12px 10px 10px 16px;
      margin: 12px 12px 12px 0;
      box-sizing: border-box;
      justify-content: flex-start;
      overflow-wrap: break-word;
      word-break: break-all;
      position: relative;
      border-radius: 16px;
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.15), 0 1.5px 4px 0 rgba(0,0,0,0.10);
      overflow-y: auto;
    }
    .block7-properties .block-label {
      position: absolute;
      top: 8px;
      right: 12px;
      margin-bottom: 0;
      font-size: 15px;
      color: #2f4f78;
      background: rgba(255,255,255,0.85);
      border-radius: 8px;
      padding: 1px 8px;
      font-weight: bold;
      z-index: 2;
    }
    .block7-content, .block7-content-secondary {
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
      box-sizing: border-box;
    }
    .block7-content {
      font-size: 1.1em;
      color: #222;
      word-break: break-word;
      width: 100%;
      margin-top: 12px;
      font-family: Georgia, serif;
    }
    .block7-content-secondary {
      font-size: 1em;
      color: #444;
      word-break: break-word;
      width: 100%;
      margin-top: 8px;
    }

    /* 新增：讓 block5 的 .btn-help 固定在右上角 */
    #block5 > .btn-help {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
    }

    .block5-content {
      font-size: clamp(1em, 2.5vw, 2.2em);
      color: #2f4f78;
      margin: 10px 0 8px 0;
      padding-left: 13px;
    }
    .block5-content p {
      margin-top: 0;
      margin-bottom: 0;
    }
    .time-panel-title {
      font-family: Georgia, serif;
    }
    .time-panel-tip {
      font-size: 0.7em;
    }
    #blockContent {
      padding: 0 10px;
      box-sizing: border-box;
      text-align: center;
      font-family: Georgia, serif;
    }
    .teleport-title {
      font-family: Georgia, serif;
    }
    .teleport-desc {
      text-align: left;
      margin-left: 0;
      padding-left: 0;
      font-family: Arial, sans-serif;
    }
    .highlight-explain {
      background: #cce6ff;
      color: #003366;
      font-weight: bold;
      padding: 0 3px;
      border-radius: 4px;
    }
    mjx-container[jax='CHTML'][display='true'] {
      margin: 0.09em 0 !important;
    }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">Quantum Teleportation</div>
    <div class="tab" onclick="switchTab(1)">Table 2</div>
  </div>

  <!-- Table 1 -->
  <div class="container active" id="tab0">
    <div class="block" id="block0">
      <div id="blockContent">
        <p class="teleport-title"><b>Information Flow of Quantum Teleportation on Entanglement</b></p>
        <small><div class="teleport-desc">
          •This simulation aims to demonstrate the explaination of quanutm information flow in a local way, and the encryption function of entanglement.<br>
          <br>• The grids show the evolution of Quantum bits(Qubits) of Schrodinger and Heisenberg's Pictures. <span class="highlight-explain">Click the "?" mark to gain further explainations.</span> Three rows of the grid represent the evolution of <i>Qubit-1</i>, <i>Qubit-2</i>, and <i>Qubit-3</i>.<br>
        <br>•Operation Process of Teleportation: Alice prepares two entangled qubits Q2 & Q3, and a qubit Q1 embedded with state information α and β at t=3. Then she would like to use some quantum gates to "teleport" the state of Q1 to Q3. <br>
          <br>• In tranditional Schrödinger's way, which we learn in the Introduction of Quantum mechanics , it is a useful tool to descript the quantum state when the qubits are fully operated. However, it was hard to explain the information flow since the state of the qubits is descrtibed in nonlocal situation. <br>
        <br>• Therefore, Heisenberg Picture provide an effective and local way for the description of information flow and the role of the entanglement.
        </div></small>
      </div>
    </div>
    <div class="block" id="block1">
      <span class="block-label">Expecation Value of Pauli X & Z</span>
      <span class="btn-help">?</span>
      <div class="pauli-expect-block">
        <div class="pauli-row"><span class="pauli-label">Q₁</span><div class="pauli-box" id="pauli-q1-left"></div><div class="pauli-box" id="pauli-q1-right"></div></div>
        <div class="pauli-row"><span class="pauli-label">Q₂</span><div class="pauli-box" id="pauli-q2-left"></div><div class="pauli-box" id="pauli-q2-right"></div></div>
        <div class="pauli-row"><span class="pauli-label">Q₃</span><div class="pauli-box" id="pauli-q3-left"></div><div class="pauli-box" id="pauli-q3-right"></div></div>
      </div>
    </div>
    <div class="block" id="block2-block">
      <div id="block2" class="block-inner">
        <span class="block-label">Schrödinger's Picture</span>
        <!-- Schrodinger picture block start -->
        <div id="block2-schrodinger">
          <div class="grid" id="grid-sch"></div>
        </div>
        <!-- Schrodinger picture block end -->
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block2-block')" id="toggle-block2">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
    <div class="block" id="block3-block">
      <div id="block3" class="block-inner">
        <span class="block-label">Quantum State</span>
        <div id="block3-quantum-state" style="color: #222;"></div>
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block3-block')" id="toggle-block3">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
    <div class="block" id="block4-block">
      <div id="block4" class="block-inner">
        <span class="block-label">Heisenberg's Picture</span>
        <!-- Heisenberg picture block start -->
        <div id="block4-heisenberg">
          <div class="grid" id="grid-hei"></div>
        </div>
        <!-- Heisenberg picture block end -->
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block4-block')" id="toggle-block4">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
    <div class="block" id="block5">
      <span class="btn-help">?</span>
      <div class="block5-flex">
        <div class="block5-main">
          <span class="block-label">•</span>
          <div class="block5-content"><p><span class="time-panel-title"><i>Time Control Panel</i></span><br><small>Try to drag the slider or click the "▷"</small></p></div>
          <div class="simple-slider-label" id="slider-t-label">t=0</div>
          <div class="simple-slider-container">
            <div class="simple-slider-track">
              <div class="simple-slider-thumb"></div>
            </div>
            <div class="simple-slider-arrow" id="slider-arrow-btn">&#9654;</div>
          </div>
        </div>
        <div class="block7-properties">
          <span class="block-label">Supplement</span>
          <div class="block7-content">
             <p><i><b>•su(2)^(⊗n) algebra</b></i>
             <br><i><b>•Unitary Matrix</b></i>
             <br><i><b>•Redundancy</b></i>
             <br><i><b>•Descriptor to State</b></i>
             <br><i><b>•More for (σx,σz)</b></i>
             </p>
            </div>
        </div>
      </div>
    </div>
    <div class="block" id="block6-block">
      <div id="block6" class="block-inner">
        <span class="block-label">Descriptors</span>
        <div id="block6-descriptor"></div>
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block6-block')" id="toggle-block6">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
  </div>

  <!-- Table 2 -->
  <div class="container" id="tab1">
    <!-- Placeholder for future enhancement -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script>
    function switchTab(index) {
      const tabs = document.querySelectorAll('.tab');
      const containers = document.querySelectorAll('.container');
      tabs.forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        containers[i].classList.toggle('active', i === index);
      });
      setTimeout(() => {
        fitGridToBlock('block2-block', 'grid-sch');
        fitGridToBlock('block4-block', 'grid-hei');
      }, 100);
    }

    function hideBlock(id) {
      document.getElementById(id).classList.add('hidden');
    }

    // block內容對應
    const blockContents = {
      block0: {
        tabs: [
          { title: "Introduction", content: `<p class=\"teleport-title\"><b>Information Flow of Quantum Teleportation on Entanglement</b></p>\
<small><div class=\"teleport-desc\">\
  •This simulation aims to demonstrate the explaination of quanutm information flow in a local way, and the encryption function of entanglement.<br>\
  <br>• The grids show the evolution of Quantum bits(Qubits) of Schrodinger and Heisenberg's Pictures. <span class=\"highlight-explain\">Click the \"?\" mark to gain further explainations.</span> Three rows of the grid represent the evolution of <i>Qubit-1</i>, <i>Qubit-2</i>, and <i>Qubit-3</i>.<br>\
<br>•Operation Process of Teleportation: Alice prepares two entangled qubits Q2 & Q3, and a qubit Q1 embedded with state information α and β at t=3. Then she would like to use some quantum gates to \"teleport\" the state of Q1 to Q3. <br>\
  <br>• In tranditional Schrödinger's way, which we learn in the Introduction of Quantum mechanics , it is a useful tool to descript the quantum state when the qubits are fully operated. However, it was hard to explain the information flow since the state of the qubits is descrtibed in nonlocal situation. <br>\
<br>• Therefore, Heisenberg Picture provide an effective and local way for the description of information flow and the role of the entanglement.\
</div></small>` },
          { title: "Protocol", content: `<p class=\"teleport-title\"><b>Introduction to the quantum Teleportation Protocol</b></p>\
<small><div class=\"teleport-desc\">\
  •The Quantum Teleportation is a fundamental protocal in quantum information science that allows for the transfer of an unknown quantum state from one location (e.g. Alice) to another location (e.g. Bob) without physically moving the qubits themselves. Instead, quantum teleportation relies on <b>Quantum entanglement</b> and <b>Classical ccommunication</b>.<br>\
  <div style=\"text-align:center;margin:7px 0;\">\
    <img src=\"Alice&Bob.png\" alt=\"Alice and Bob\" style=\"max-width:90%;height:auto;border-radius:10px;box-shadow:0 2px 12px #aaa;\" id=\"alicebob-img\">\
  </div>\
  <br>•The core of the protocal is the pair of entangled qubits shared between two locations like Alic and Bob. Suppose Alice uses an unitary gate for preparing a third qubit in an arbitraty state ∣ψ⟩=α∣0⟩+β∣1⟩ that she wishes to \"teleport\" to Bob. By performing Bell measurement on her two qubits, one in state ∣ψ⟩ and another entangled state shared with Bob's one. Then sending the measuremnet outcome to Bob via classical channel, and Bob's qubit will be transformed into the qubit ∣ψ⟩ accroding to the outcome resluts from Alice.<br>\
  <br>The figure below is the actual quantum circuit:
  <div style=\"text-align:center;margin:7px 0;\">\
    <img src=\"figure1.jpeg\" alt=\"figure1\" style=\"max-width:90%;height:auto;border-radius:10px;box-shadow:0 2px 12px #aaa;\" id=\"alicebob-img\">\
  </div>\
  <br>•In the fact that the original quantum state is destroyed at Alice's side and reappeares at Bob's. This is so-called <b>no-cloning theorem</b> and ensuring relativistic causality. Therefore the communication of the teleportation does not permit <u>faster than light</u>.<br>\
  <br>•To simplify the proccess in teleportation, this website concentrate on how Alice \"teleport\" the quantum state from the first Qubit-1 to the third Qubit-3. Bob can take a rest in this simulation.
  </div></small>` },
        ],
        schTabs: [
          { title: "Schrödinger", content: `<p{margin-bottom: 0.1em;} class=\"teleport-title\">Schrödinger's Picture <div class=\"teleport-desc\"><small>\n               \n           
            <br>• In this Picture, <b class=\"teleport-title\"> the state evolves with time</b>, while the observables/operators remain constant.. The quantum circuit at <i class=\"teleport-title\">top, middle, and bottom</i> indicate the evolution of <i class=\"teleport-title\">Qubits 1,2, and 3</i> respectively. Therefore, the observables only act at once which are highlighted at corresponding time value and only the state <b>Ψₜ</b> varied.\n               <br>\n               \n          
             <br>• Additionaly, the line "-" in the circuit act as the identity unitaty matrix "<i class=\"teleport-title\">I</i>" (i.e., leaves the state unchanged)..\n               <br>\n               \n           
            <br>• The state at the beginning represented in braket notation is shown below, which indicates the Qubit1,2,3 from left to right:\n                   \\[|000\\rangle = |0\\rangle \\otimes |0\\rangle \\otimes |0\\rangle\\]\n               \n           
            <br>• It is obvious to observe that the quantum <span class=\"highlight-explain\">states evolve</span> in time(t). For example at t=3 on Qubit-1:\n                   \\[\\begin{align*}\n                   &|\\Psi_3^{q1}\\rangle = UII|\\Psi_0^{q1}\\rangle = U|0\\rangle = \\alpha |0\\rangle + \\beta |1 \\rangle \\\\n                   &|0\\rangle =\\begin{pmatrix}1 \\\\ 0\\end{pmatrix}\\, \\&\\, |1\\rangle =\\begin{pmatrix}0 \\\\ 1\\end{pmatrix}\\n                   \\end{align*}\\]\n\n               \n           
            <br>• Each highlighted box represent an Unitary Matrix(click the block7 "?" for more explaination). "H" is a typical unitray matrix caled <span class=\"highlight-explain\">Hadamard Gate</span>:\n                   \\[\\begin{align*}\n                   &|\\Psi_1^{q2}\\rangle = H|\\Psi_0^{q2}\\rangle = H|0\\rangle = \\frac{1}{\\sqrt{2}}\\begin{pmatrix}1 & 1 \\\\ 1 & -1\\end{pmatrix}\\begin{pmatrix}1 \\\\ 0\\end{pmatrix}\\n                   &=\\frac{1}{\\sqrt{2}}\\left(|0\\rangle + |1\\rangle\\right)\n                   \\end{align*}\\]\n                   \n               \n           
            <br>•The <span class=\"highlight-explain\">Controlled-not(Cnot) Gate</span> flips the target qubit (at "X") only when the control qubit (at "•") is in state |1⟩ (e.g.|0> → |1>, or |1> → |0>). For examples:\n                   \\[Cnot\\left(|01\\rangle +|11\\rangle\\right) = |01\\rangle +|10\\rangle\\]\n               
            </small></div></p>` },
          
          { title: "v.s.", content: `<p{margin-bottom: 0.1em;} class=\"teleport-title\">The Comparision between Schrödinger's and Heisenberg's Picture <div class=\"teleport-desc\"><small>\n               \n           
            <br>•               
            <br>        
            </small></div></p>` },

          { title: "Heisenberg", content: `<p{margin-bottom: 0.1em;} class=\"teleport-title\">Heisenberg's Picture <div class=\"teleport-desc\"><small>\n              \n            In the Heisenberg picture, the quantum state is treated as a fixed reference (e.g., |000⟩), and all dynamics are represented as the time evolution of operators <b class=\"highlight-explain\">Q(t)</b> instead.\n                  <br>\n                 \n            
            <br>•At this moment, when you drag the time slider, the gates will keep highlighted which means that the operator will always be influenced by the gates before t, even identical gate will be considered. Taking the Qubit-1 at t=3 for an example:\n              \\[\\begin{align*}\n              &q_1(3) = U^{\\dagger}q_1(2)U = U^{\\dagger} I^{\\dagger} q_1(1)I\\,U \\\\n              &= U^{\\dagger} I^{\\dagger} I^{\\dagger} q_1(0)I\\,I\\,U\n              \\end{align*}\\]\n              \n            
            <br>•So if the state is in constant, how could we describe the quantum system of each qubit? No worry, <b class=\"highlight-explain\">descriptor</b> is perfectly applied to illustrate the system. \n                  Just like the Cartesian coordinate(x,y,z), decriptor (qx,qy,qz) is used to describe the orientation on Bloch sphere, showing how it behaves under X, Y, Z measurements.\n                  According to su(2) algebra, (qx,qz) is convenient enough for all description(more for Redundancy on <i>Supplement</i>). \n                  \n            
            <br>•<u>At the beginning of the Qubit-1, it holds the basic Pauli matrix inside the descriptor which is</u>:\n                  \\[q_1(0)=\\left(\\sigma_x(0),\\sigma_z(0)\\right)=\\left(X,Z\\right)\\]\n                  and the Qubit-1 at t=3 will be:\n                  \\[\\begin{align*}\n                  &q_1(3)=U^{\\dagger} I^{\\dagger} I^{\\dagger} \\left(\\sigma_{1x}(0),\\sigma_{1z}(0)\\right)I\\,I\\,U\\\\n                  &=\\left(D_{1x}(0),D_{1z}(0)\\right)\n                  \\end{align*}\\]\n                  <b>where "D" means the information of <span style=\"color:red;\">α</span> and <span style=\"color:red;\">β</span> have been stored in that descriptor</b>. More math description placed below.\n                  <br>\n                  \n            
            <br>•More details of Qubit-1 at t=3:\n                  \\[\\begin{align*}\n                  &\\left(D_{1x}(0),D_{1z}(0)\\right) = \\left(U^{\\dagger}\\sigma_x\\,U,U^{\\dagger}\\sigma_z\\,U)\\right)\\\\n                  &= \\bigr[(2\\alpha\\beta\\sigma_z+(\\alpha^2-\\beta^2)\\sigma_x),(-2\\alpha\\beta\\sigma_x+(\\alpha^2-\\beta^2)\\sigma_z)\\bigr]\\\\n                  &where\\,\\,\\,U = \\begin{pmatrix}\\alpha & -\\beta \\\\ \\beta & \\alpha\\end{pmatrix}\n                  \\end{align*}\\]\n                  \n                  \n            
            <br>•If you are interested in converting the descriptor into classical state, you can check from the equations in <i>Supplement</i>.\n                  <br>\n                  \n            
            <br>•The operator Q(t) includes all three qubits' descriptors:\n                  \\[\\begin{align*}\n                  &Q(t)=\\left(q_1(t),q_2(t),q_3(t)\\right)\\n                  &= \\Bigr[ (q_{1x}(t),q_{1z}(t)),(q_{2x}(t),q_{2z}(t)),(q_{3x}(t),q_{3z}(t))\\Bigr]\n                  \\end{align*}\\]\n              
            </small></div></p>` },
        ],
        // quantumTabs 先不在這裡定義
      },
      block1: `<p{margin-bottom: 0.1em;} class="teleport-title">Expectaitonal Outcomes of Qubits(Q₁,Q₂,Q₃) on Pauli Operators <span class="highlight-explain">X</span>(left-hand boxes) & <span class="highlight-explain">Z</span>(right-hand boxes)<div class="teleport-desc"><small>
               <br>• The expectation value of operator X&Z will be calculated(It's straight-forward as we encountered in basic quantum courses.):
                   \\[\\langle\\psi_t|X\\otimes X\\otimes X|\\psi_t\\rangle\\, \\&\\, \\langle\\psi_t|Z\\otimes Z\\otimes Z|\\psi_t\\rangle\\]
               <br>• In Heisenberg's Picture, the expectation outcomes will be found from descriptor with the reference state |0>:
                   \\[\\langle 000|(U_i x(t), U_i z(t))|000\\rangle\\]
               <br>• However, they will result the equal outcomes. For example(at t=0):
                   \\[\\begin{align*}
                     &(\\langle 000|X\\otimes X\\otimes X|000\\rangle , \\langle 000|Z\\otimes Z\\otimes Z|000\\rangle)\\\\
                     &=\\langle 000|(\\sigma_i x(0), \\sigma_i z(0))|000\\rangle \\\\
                     &=[(0,1),(0,1),(0,1)]\\\\
                   \\end{align*}\\]
               </small></div></p>`,

      block2: `<p{margin-bottom: 0.1em;} class="teleport-title">Schrödinger's Picture <div class="teleport-desc"><small>
               <br>• In this Picture, <b class="teleport-title"> the state evolves with time</b>, while the observables/operators remain constant.. The quantum circuit at <i class="teleport-title">top, middle, and bottom</i> indicate the evolution of <i class="teleport-title">Qubits 1,2, and 3</i> respectively. Therefore, the observables only act at once which are highlighted at corresponding time value and only the state <b>Ψₜ</b> varied.
               <br>
               <br>• Additionaly, the line "-" in the circuit act as the identity unitaty matrix "<i class="teleport-title">I</i>" (i.e., leaves the state unchanged)..
               <br>
               <br>• The state at the beginning represented in braket notation is shown below, which indicates the Qubit1,2,3 from left to right:
                   \\[|000\\rangle = |0\\rangle \\otimes |0\\rangle \\otimes |0\\rangle\\]
               <br>• It is obvious to observe that the quantum <span class="highlight-explain">states evolve</span> in time(t). For example at t=3 on Qubit-1:
                   \\[\\begin{align*}
                   &|\\Psi_3^{q1}\\rangle = UII|\\Psi_0^{q1}\\rangle = U|0\\rangle = \\alpha |0\\rangle + \\beta |1 \\rangle \\\\
                   &|0\\rangle =\\begin{pmatrix}1 \\\\ 0\\end{pmatrix}\\, \\&\\, |1\\rangle =\\begin{pmatrix}0 \\\\ 1\\end{pmatrix}\\\\
                   \\end{align*}\\]

               <br>• Each highlighted box represent an Unitary Matrix(click the block7 "?" for more explaination). "H" is a typical unitray matrix caled <span class="highlight-explain">Hadamard Gate</span>:
                   \\[\\begin{align*}
                   &|\\Psi_1^{q2}\\rangle = H|\\Psi_0^{q2}\\rangle = H|0\\rangle = \\frac{1}{\\sqrt{2}}\\begin{pmatrix}1 & 1 \\\\ 1 & -1\\end{pmatrix}\\begin{pmatrix}1 \\\\ 0\\end{pmatrix}\\\\
                   &=\\frac{1}{\\sqrt{2}}\\left(|0\\rangle + |1\\rangle\\right)
                   \\end{align*}\\]
                   
               <br>•The <span class="highlight-explain">Controlled-not(Cnot) Gate</span> flips the target qubit (at "X") only when the control qubit (at "•") is in state |1⟩ (e.g.|0> → |1>, or |1> → |0>). For examples:
                   \\[Cnot\\left(|01\\rangle +|11\\rangle\\right) = |01\\rangle +|10\\rangle\\]
               </small></div></p>`,

      block3: `<p{margin-bottom: 0.1em;} class="teleport-title">The Evolution of Quantum State<div class="teleport-desc"><small>
               <br><i>This block demonstrates state Ψₜ in a concrete expansion.</i>
               <br>
               <br>•At <b><i class="highlight-explain">t=2</i></b>, the Qubit-2 and Qubit-3 are <b>entangled</b>, which means the state of Qubits2&3 Ψₜ cannot be expressed as the tensor product of any two explict states, here is the example:
               \\[\\begin{align*}
               &|\\Psi_2\\rangle = \\frac{1}{\\sqrt{2}} |0\\rangle \\otimes \\left(|00\\rangle + |11\\rangle\\right)\\\\
               &≠\\frac{1}{\\sqrt{2}} |0\\rangle \\otimes |\\phi\\rangle \\otimes |\\theta\\rangle,\\,\\,for\\,any\\,\\,\\phi\\,and\\,\\,\\theta
               \\end{align*}\\]

               <br>•At <b><i class="highlight-explain">t=3</i></b>, <span style="color:red;">Alice</span> encodes the information <span style="color:red;">α</span> and <span style="color:red;">β</span> in Qubit-1 by using "U" operator.
               From now on, we will have no idea where the information <span style="color:red;">α</span> and <span style="color:red;">β</span> located in which qubit even though they are sent from Alice.  
               \\[\\textcolor{red}{\\alpha}|000\\rangle =  |0\\rangle\\otimes \\textcolor{red}{\\alpha}|0\\rangle \\otimes |0\\rangle =|0\\rangle\\otimes |0\\rangle\\otimes \\textcolor{red}{\\alpha}|0\\rangle\\]
               
               <br>•At <b><i class="highlight-explain">t=5</i></b>, The Qubit-1 and Qubit-2 are operated by Bell measurement which projects these two qubits onto one of four maximal entangled states. Simply saying, the state becomes the following form:
               \\[\\begin{align*}
               &|\\Psi_5\\rangle =\\frac{1}{2}(|00\\rangle |\\psi\\rangle +|01\\rangle X|\\psi\\rangle\\\\
               &+|10\\rangle Z|\\psi\\rangle +|11\\rangle ZX|\\psi\\rangle)\\\\
               & where\\,:\\, |\\psi\\rangle = \\alpha |0\\rangle + \\beta |1\\rangle
               \\end{align*}\\]

               <br>•From <b><i class="highlight-explain">t=6 to t=8</i></b>, the expansion of state Ψ₈ becomes much more complicated. However, we still can't tell the location of "α" & "β" at this moment. Therefore, some may interpret the quantum teleportation process as exhibiting <b>nonlocality</b>, due to the entangled correlations and measurement-induced collapse.
               <br>
               <br>•At <b><i class="highlight-explain">t=9</i></b>, the teleportation seems to be completed. No matter what "0" or "1" we measure at Qubit-1 and Qubit-2, the Qubit-3 will finally become |ψ> we need.
               \\[\\frac{1}{2}\\left(|00\\rangle + |01\\rangle + |10\\rangle +|11\\rangle\\right)\\otimes |\\psi\\rangle\\]
               <br>•However, this Picture cannot explain how the quantum information flow from Qubit-1 to Qubit-3 and the function of entanglement. <b>The α and β are just being teleported to Q3 like a magic</b>.
               </small></div></p>`,

      block4: `<p{margin-bottom: 0.1em;} class="teleport-title">Heisenberg's Picture <div class="teleport-desc"><small>
              <br>•The state of Qubits have no longer been decribed in this Picture. In contract, only gates are performed as the discrete time variation, called the evolution of operators. Similar to what we learn in classical relative motion, velocity and position of an object changes respected to another as in frame of reference. Here we take |000> as the <i class="highlight-explain">reference vector</i> state.
                  In the Heisenberg picture, the quantum state is treated as a fixed reference (e.g., |000⟩), and all dynamics are represented as the time evolution of operators <b class="highlight-explain">Q(t)</b> instead.
                  <br>
                  <br>•At this moment, when you drag the time slider, the gates will keep highlighted which means that the operator will always be influenced by the gates before t, even identical gate will be considered. Taking the Qubit-1 at t=3 for an example:
              \\[\\begin{align*}
              &q_1(3) = U^{\\dagger}q_1(2)U = U^{\\dagger} I^{\\dagger} q_1(1)I\\,U \\\\
              &= U^{\\dagger} I^{\\dagger} I^{\\dagger} q_1(0)I\\,I\\,U
              \\end{align*}\\]
              <br>•So if the state is in constant, how could we describe the quantum system of each qubit? No worry, <b class="highlight-explain">descriptor</b> is perfectly applied to illustrate the system. 
                  Just like the Cartesian coordinate(x,y,z), decriptor (qx,qy,qz) is used to describe the orientation on Bloch sphere, showing how it behaves under X, Y, Z measurements.
                  According to su(2) algebra, (qx,qz) is convenient enough for all description(more for Redundancy on <i>Supplement</i>). 
                  <br>•<u>At the beginning of the Qubit-1, it holds the basic Pauli matrix inside the descriptor which is</u>:
                  \\[q_1(0)=\\left(\\sigma_x(0),\\sigma_z(0)\\right)=\\left(X,Z\\right)\\]
                  and the Qubit-1 at t=3 will be:
                  \\[\\begin{align*}
                  &q_1(3)=U^{\\dagger} I^{\\dagger} I^{\\dagger} \\left(\\sigma_{1x}(0),\\sigma_{1z}(0)\\right)I\\,I\\,U\\\\
                  &=\\left(D_{1x}(0),D_{1z}(0)\\right)
                  \\end{align*}\\]
                  <b>where "D" means the information of <span style="color:red;">α</span> and <span style="color:red;">β</span> have been stored in that descriptor</b>. More math description placed below.
                  <br>
                  <br>•More details of Qubit-1 at t=3:
                  \\[\\begin{align*}
                  &\\left(D_{1x}(0),D_{1z}(0)\\right) = \\left(U^{\\dagger}\\sigma_x\\,U,U^{\\dagger}\\sigma_z\\,U)\\right)\\\\
                  &= \\bigr[(2\\alpha\\beta\\sigma_z+(\\alpha^2-\\beta^2)\\sigma_x),(-2\\alpha\\beta\\sigma_x+(\\alpha^2-\\beta^2)\\sigma_z)\\bigr]\\\\
                  &where\\,\\,\\,U = \\begin{pmatrix}\\alpha & -\\beta \\\\ \\beta & \\alpha\\end{pmatrix}
                  \\end{align*}\\]
                  
                  <br>•If you are interested in converting the descriptor into classical state, you can check from the equations in <i>Supplement</i>.
                  <br>
                  
                  <br>•The operator Q(t) includes all three qubits' descriptors:
                  \\[\\begin{align*}
                  &Q(t)=\\left(q_1(t),q_2(t),q_3(t)\\right)\\\\
                  &= \\Bigr[ (q_{1x}(t),q_{1z}(t)),(q_{2x}(t),q_{2z}(t)),(q_{3x}(t),q_{3z}(t))\\Bigr]
                  \\end{align*}\\]
              </small></div></p>`,

      block5: `<p{margin-bottom: 0.1em;} class="teleport-title">Supplementay Contents<div class="teleport-desc"><small>
              <br>•Properties of <b><i>su(2)^(⊗n)</i></b> algebra:
              \\[\\begin{align*}
              &[q_{iw}(0),q_{jw'}(t)]=0\\,\\,\\,(i≠j\\,and\\,\\forall w,w')\\\\
              &q_{ix}(0)q_{iy}(0)=iq_{iz}(0)\\,\\,\\,(cyclic permutations)\\\\
              &q_w(0)^2=I\\,\\,\\,(\\forall w)
              \\end{align*}\\]
              <br>•Unitary Matrix:
              \\[U^{\\dagger}=U^{-1}\\,\\,\\&\\,\\, U^{\\dagger}U=I\\]
              <br>•Redundancy on descriptor(I,qx,qy,qz):
              <br>According to the properties of su(2) algebra
              \\[\\begin{align*}&(I,q_x(0),q_y(0),q_z(0))\\\\
              &=(q_x^2(0),q_x(0),-iq_z(0)q_x(0),q_z(0))\\end{align*}\\]
              Hence I and y components can be found by x and z components for simplification (qx,qz).
              <br>
              <br>•Converting Descriptor to State of Qubit-1 can be calculated from the following equation:
              \\[\\begin{align*}
                  &|\\Psi_3^{q1}\\rangle=\\cos{\\frac{\\theta}{2}}|0\\rangle + e^{i\\phi}\\sin{\\frac{\\theta}{2}}|1\\rangle\\\\
                  &for\\,\\,\\,\\left(\\langle q_x\\rangle,\\langle q_z\\rangle\\right)= \\left(\\cos{\\theta}\\sin{\\phi}, \\cos{\\phi}\\right)
                  \\end{align*}\\]
              <br>•More for (σx,σz):
              <br>A descriptor is defined as a tuple of Pauli operators (σx, σz), representing how the qubit's observables evolve over time. When evaluated on a reference state (like |000⟩), these yield the time-dependent expectation values ⟨qₓ(t)⟩, ⟨q_z(t)⟩.
              </small></div></p>`,

      block6: `<p{margin-bottom: 0.1em;} class="teleport-title">The Evolution of Descriptors<div class="teleport-desc"><small>
               <br>•This block demonstrate the descriptors evolution of qubits. Through the application of descriptors, we can easily trace the information flow of <span style="color:red;">α</span> and <span style="color:red;">β</span> stored in D₁x and D₁z ("D"), and how the entanglement is used for encryption and decryption. 
               <br>
               <br>•The quantum gates act on descriptor will be quite different from the state operation:
               <br><span class="highlight-explain">Hadamard Gate</span> on descriptor:
               \\[(q_{x(t)},q_{z(t)})\\stackrel{H}{\\longrightarrow}(q_{z(t-1)},q_{x(t-1)})\\]
               <span class="highlight-explain">Controlled-not Gate</span> on descriptor:
               \\[\\begin{align*}
               &(q_{cx(t)},q_{cz(t)})\\stackrel{•}{\\longrightarrow}(q_{cx(t-1)}q_{tx(t-1)},q_{cz(t-1)})\\\\
               &(q_{tx(t)},q_{tz(t)})\\stackrel{X}{\\longrightarrow}(q_{tx(t-1)},q_{cz(t-1)}q_{tz(t-1)})
               \\end{align*}\\]
               
               <br>•At <b><i class="highlight-explain">t=2</i></b>, Qubit-2 and Qubit-3 are entangled with each other which perform as sharing a part of descriptor to one anothor. The descriptors of Qubit-2 and Qubit-3 become correlated(<span style="color:magenta;">σ₃x</span> & <span style="color:deepskyblue;">σ₂x</span>), such that their X components are entangled and no longer independent. It reflects the underlying quantum entanglement between the two qubits.
                   <br>•This can be seen as providing an unique key so that the expectation outcomes of Q2 and Q3 will always be zero after the measurement, because any measurement at Q2 will affect the result of Q3 and  vice versa.
                   \\[\\begin{align*}
                   &\\langle 00|(\\sigma_{2z} \\sigma_{3x},\\sigma_{2x})|00\\rangle = \\langle 00|(\\sigma_{3x} ,\\sigma_{3z}\\sigma_{2x})|00\\rangle \\\\
                   &=(0,0)
                   \\end{align*}\\]
               <br>•At <b><i class="highlight-explain">t=3</i></b>, Alice uses an Unitary gate to encode the quantum information inside the Qubit-1, but we don't know the exact value of "α" and "β". Therefore, we use the "D" to trace that information.
               \\[\\begin{align*}
               &q_1(3)=U^{\\dagger} I^{\\dagger} I^{\\dagger} \\left(\\sigma_{1x}(0),\\sigma_{1z}(0)\\right)I\\,I\\,U\\\\
               &=\\left(D_{1x}(0),D_{1z}(0)\\,\\right)
               \\end{align*}\\]
               <br>•At <b><i class="highlight-explain">t=4</i></b>, the z-component "D₁z" has been copied into the Qubit-2 with a key "σ₂x". Meanwhile, the key of "σ₃x" will be embedded in "D₁z" component in Qubit-1.
                    It is because the measurement of reference vector |0> applies to Pauli X (σ_x) will be zero. By the properties of su^2 algebra, square of X is equal to <i>I</i> which can be used for "unlock" the information.
               \\[\\langle 00|D_{x}\\sigma_x |00\\rangle =0\\\,\\,\\,\\&\\,\\,\\,\\sigma_x^2=I\\]
                
               <br>•At <b><i class="highlight-explain">t=5</i></b>, changing the Qubit-1 position of "D₁xσ₂zσ₃x" into the z-compnent which is for later measurement. At this momoent, "D₁zσ₂x" and "D₁xσ₂zσ₃x" are fully encrypted and thier expectation values becomes zero. 
                   This called "Bell Measurement" which transfer the entangled correlations "σ₂zσ₃x" to Qubit-1.
               <br>    
               <br>•From <b><i class="highlight-explain">t=6 to t=9</i></b>, these processes called the "decryption" which unlock the keys embedded in "D". The Cnot gates transform the operators such that Qubit-3's observable becomes functionally dependent on the originally encoded D₁x and D₁z.
               <br>•For Cnot gate at <b><i class="highlight-explain">t=6</i></b>, "D₁z" transmittion:
               \\[q_{3z}(6)=q_{2z}(5)q_{3z}(5)=D_{1z}\\sigma_{2x}^2\\sigma_{3z} =D_{1z}\\sigma_{3z}\\]
               (Qubit-2 and Qubit-3 are no longer entangled at this moment, since the Qubit-2 contains nothing about correlative component of Qubit-3)
               <br>•For Cnot gate at <b><i class="highlight-explain">t=8</i></b>, "D₁x" transmittion:
               \\[q_{3z}(8)=q_{1z}(7)q_{3z}(7)=D_{1x}\\sigma_{2z}\\sigma_{3x}^2 =D_{1x}\\sigma_{2z}\\]
               •"H" gates at <b><i class="highlight-explain">t=7</i></b> and <b><i class="highlight-explain">t=9</i></b> used to switch the x-z components so that the Cnot gates can transfer the information "D" to Qubit-3 properly.
               <br>
               <br>•Finally we can clearly see how the information "α" and "β" stored in "D" flow from Qubit-1 to Qubit-3 through Cnot and Hadamard Gates. Meanwhile, the descriptor has a well explaination on how entanglement encripts and decrypts the quantum information in the circuit.
               And the expectation outcomes of Qubit-3 equal to the outcomes of Qubit-1 at t=3, which means the information for rebuilding target state in Qubit-3 has been successfully transfered.

               </small></div></p>`,
    };
    // blockContents 定義後再補上 quantumTabs，避免 undefined
    blockContents.block0.quantumTabs = [
      { title: "Q_State", content: blockContents.block3 },
      { title: "v.s.", content: `<p>New content for tab 5. (請填入新內容)</p>` },
      { title: "Descriptors", content: blockContents.block6 },
    ];
    function showBlockContent(blockId, schTabIdx = null, quantumTabIdx = null) {
      const content = document.getElementById("blockContent");
      if (blockId === "block0" && blockContents.block0) {
        // 量子三分頁
        if (quantumTabIdx !== null && blockContents.block0.quantumTabs) {
          let tabs = blockContents.block0.quantumTabs;
          let tabBar = `<div id='block0-quantum-tabs' style='display:flex;gap:8px;margin-bottom:10px;'>`;
          tabs.forEach((tab, i) => {
            tabBar += `<div class='block0-quantum-tab' data-idx='${i}' style='padding:6px 18px;cursor:pointer;border-radius:8px 8px 0 0;background:${i===quantumTabIdx?"#fff":"#eee"};color:${i===quantumTabIdx?"#2f4f78":"#888"};font-weight:${i===quantumTabIdx?"bold":"normal"};border:1px solid #ccc;border-bottom:none;'>${tab.title}</div>`;
          });
          tabBar += `</div>`;
          let tabContents = `<div id='block0-quantum-tab-content' style='min-height:60px;'>${tabs[quantumTabIdx].content}</div>`;
          content.innerHTML = tabBar + tabContents;
          // Tab click event
          content.querySelectorAll('.block0-quantum-tab').forEach(tabEl => {
            tabEl.onclick = function() {
              let idx = +tabEl.dataset.idx;
              content.querySelectorAll('.block0-quantum-tab').forEach((el, j) => {
                el.style.background = (j===idx)?"#fff":"#eee";
                el.style.color = (j===idx)?"#2f4f78":"#888";
                el.style.fontWeight = (j===idx)?"bold":"normal";
              });
              content.querySelector('#block0-quantum-tab-content').innerHTML = tabs[idx].content;
              autoFitBlock0Font();
              if (window.MathJax && /\\\(|\\\[|\$/.test(tabs[idx].content)) {
                MathJax.typesetPromise([content.querySelector('#block0-quantum-tab-content')]).then(() => {
                  autoFitBlock0Font();
                });
              }
            }
          });
          autoFitBlock0Font();
          if (window.MathJax && /\\\(|\\\[|\$/.test(tabs[quantumTabIdx].content)) {
            MathJax.typesetPromise([content.querySelector('#block0-quantum-tab-content')]).then(() => {
              autoFitBlock0Font();
            });
          }
          return;
        }
        // 檢查是否要顯示 Schrodinger tabs
        if (schTabIdx !== null && blockContents.block0.schTabs) {
          let tabs = blockContents.block0.schTabs;
          let tabBar = `<div id='block0-sch-tabs' style='display:flex;gap:8px;margin-bottom:10px;'>`;
          tabs.forEach((tab, i) => {
            tabBar += `<div class='block0-sch-tab' data-idx='${i}' style='padding:6px 18px;cursor:pointer;border-radius:8px 8px 0 0;background:${i===schTabIdx?"#fff":"#eee"};color:${i===schTabIdx?"#2f4f78":"#888"};font-weight:${i===schTabIdx?"bold":"normal"};border:1px solid #ccc;border-bottom:none;'>${tab.title}</div>`;
          });
          tabBar += `</div>`;
          let tabContents = `<div id='block0-sch-tab-content' style='min-height:60px;'>${tabs[schTabIdx].content}</div>`;
          content.innerHTML = tabBar + tabContents;
          // Tab click event
          content.querySelectorAll('.block0-sch-tab').forEach(tabEl => {
            tabEl.onclick = function() {
              let idx = +tabEl.dataset.idx;
              // 切換tab樣式
              content.querySelectorAll('.block0-sch-tab').forEach((el, j) => {
                el.style.background = (j===idx)?"#fff":"#eee";
                el.style.color = (j===idx)?"#2f4f78":"#888";
                el.style.fontWeight = (j===idx)?"bold":"normal";
              });
              // 切換內容
              content.querySelector('#block0-sch-tab-content').innerHTML = tabs[idx].content;
              autoFitBlock0Font();
              if (window.MathJax && /\\\(|\\\[|\$/.test(tabs[idx].content)) {
                MathJax.typesetPromise([content.querySelector('#block0-sch-tab-content')]).then(() => {
                  autoFitBlock0Font();
                });
              }
            }
          });
          autoFitBlock0Font();
          if (window.MathJax && /\\\(|\\\[|\$/.test(tabs[schTabIdx].content)) {
            MathJax.typesetPromise([content.querySelector('#block0-sch-tab-content')]).then(() => {
              autoFitBlock0Font();
            });
          }
          return;
        }
        // 原本的 Introduction/Protocol tabs
        let tabs = blockContents.block0.tabs;
        let tabBar = `<div id='block0-tabs' style='display:flex;gap:8px;margin-bottom:10px;'>`;
        tabs.forEach((tab, i) => {
          tabBar += `<div class='block0-tab' data-idx='${i}' style='padding:6px 18px;cursor:pointer;border-radius:8px 8px 0 0;background:${i===0?"#fff":"#eee"};color:${i===0?"#2f4f78":"#888"};font-weight:${i===0?"bold":"normal"};border:1px solid #ccc;border-bottom:none;'>${tab.title}</div>`;
        });
        tabBar += `</div>`;
        let tabContents = `<div id='block0-tab-content' style='min-height:60px;'>${tabs[0].content}</div>`;
        content.innerHTML = tabBar + tabContents;
        // Tab click event
        content.querySelectorAll('.block0-tab').forEach(tabEl => {
          tabEl.onclick = function() {
            let idx = +tabEl.dataset.idx;
            // 切換tab樣式
            content.querySelectorAll('.block0-tab').forEach((el, j) => {
              el.style.background = (j===idx)?"#fff":"#eee";
              el.style.color = (j===idx)?"#2f4f78":"#888";
              el.style.fontWeight = (j===idx)?"bold":"normal";
            });
            // 切換內容
            content.querySelector('#block0-tab-content').innerHTML = tabs[idx].content;
            autoFitBlock0Font();
            if (window.MathJax && /\\\(|\\\[|\$/.test(tabs[idx].content)) {
              MathJax.typesetPromise([content.querySelector('#block0-tab-content')]).then(() => {
                autoFitBlock0Font();
              });
            }
          }
        });
        autoFitBlock0Font();
        if (window.MathJax && /\\\(|\\\[|\$/.test(tabs[0].content)) {
          MathJax.typesetPromise([content.querySelector('#block0-tab-content')]).then(() => {
            autoFitBlock0Font();
          });
        }
        return;
      }
      content.innerHTML = blockContents[blockId] || 'Block 0 content...';
      autoFitBlock0Font();
      if (window.MathJax && /\\\(|\\\[|\$/.test(content.innerHTML)) {
        MathJax.typesetPromise([content]).then(() => {
          autoFitBlock0Font();
        });
      }
    }
    // 問號按鈕事件綁定（可重複呼叫）
    function bindHelpButtons(scope=document) {
      scope.querySelectorAll('.btn-help').forEach(btn => {
        btn.onclick = function(e) {
          e.stopPropagation();
          let block = btn.closest('.block-inner') || btn.closest('.block');
          if (block && block.id && block.id !== 'block0') {
            // Schrodinger/Heisenberg 問號跳到 block0 的 schTabs
            if (block.id === 'block2' || block.id === 'block2-block') {
              showBlockContent('block0', 0); // tab1
            } else if (block.id === 'block4' || block.id === 'block4-block') {
              showBlockContent('block0', 2); // Heisenberg tab (第三個)
            } else if (block.id === 'block3' || block.id === 'block3-block') {
              showBlockContent('block0', null, 0); // quantumTabs[0] (tab4)
            } else if (block.id === 'block6' || block.id === 'block6-block') {
              showBlockContent('block0', null, 2); // quantumTabs[2] (tab6)
            } else {
              showBlockContent(block.id);
            }
          }
        }
      });
    }
    function initSimpleSlider() {
      const track = document.querySelector('.simple-slider-track');
      const thumb = document.querySelector('.simple-slider-thumb');
      const tLabel = document.getElementById('slider-t-label');
      if (!track || !thumb || !tLabel) return;
      // Ten nonlinear points (0,1,2,3,4,5,6,7,8,9)
      const ticks = [0,1,2,3,4,5,6,7,8,9];
      const tickPercents = ticks.map((v,i,arr) => i/(arr.length-1));
      let valueIdx = 0;
      let currentT = 0;
      function setThumb(idx) {
        valueIdx = idx;
        currentT = idx;
        window.getCurrentT = () => currentT;
        thumb.style.left = (tickPercents[idx]*100) + '%';
        tLabel.textContent = 't=' + ticks[idx];
        // Update block2's Schrodinger picture
        updateSchrodingerGrid(idx);
        // Update block4's Heisenberg picture
        updateHeisenbergGrid(idx);
        // Update block1's Pauli expectation
        updatePauliExpectation(idx);
        // Update block3's quantum state
        updateBlock3QuantumState(idx);
        // Update block6's descriptor
        updateBlock6Descriptor(idx);
      }
      setThumb(0);
      // Add: triangle button click event
      document.getElementById('slider-arrow-btn').onclick = function(e) {
        if (valueIdx < ticks.length - 1) {
          setThumb(valueIdx + 1);
        } else {
          setThumb(0);
        }
      };
      let dragging = false;
      let trackRect = null;
      function preventSelection(e) {
        e.preventDefault();
        return false;
      }
      thumb.onmousedown = function(e) {
        dragging = true;
        trackRect = track.getBoundingClientRect();
        document.body.style.userSelect = 'none';
        document.addEventListener('selectstart', preventSelection);
      };
      document.addEventListener('mousemove', function(e) {
        if (!dragging) return;
        let x = e.clientX - trackRect.left;
        x = Math.max(0, Math.min(x, trackRect.width));
        let percent = x / trackRect.width;
        // snap to 最近的 tick
        let idx = tickPercents.reduce((prev, curr, i) => Math.abs(curr-percent)<Math.abs(tickPercents[prev]-percent)?i:prev, 0);
        setThumb(idx);
      });
      document.addEventListener('mouseup', function(e) {
        dragging = false;
        document.body.style.userSelect = '';
        document.removeEventListener('selectstart', preventSelection);
      });
      // Click on the track can also move the thumb
      track.onclick = function(e) {
        if (e.target === thumb) return;
        trackRect = track.getBoundingClientRect();
        let x = e.clientX - trackRect.left;
        x = Math.max(0, Math.min(x, trackRect.width));
        let percent = x / trackRect.width;
        let idx = tickPercents.reduce((prev, curr, i) => Math.abs(curr-percent)<Math.abs(tickPercents[prev]-percent)?i:prev, 0);
        setThumb(idx);
      };
    }
    window.onload = function() {
      try {
        bindHelpButtons();
        initSimpleSlider();
        // Initialize block0 tabs content
        showBlockContent('block0');
        // Initialize block2's Schrodinger picture
        initGridSch();
        updateSchrodingerGrid(0);
        observeBlockResize('block2-block', 'grid-sch');
        // Initialize block4's Heisenberg picture
        initGridHei();
        updateHeisenbergGrid(0);
        observeBlockResize('block4-block', 'grid-hei');
        // Initialize block1's Pauli expectation (move to last to ensure DOM is rendered)
        setTimeout(() => updatePauliExpectation(0), 0);
        // Initialize block3's quantum state
        updateBlock3QuantumState(0);
        // Initialize block6's descriptor
        updateBlock6Descriptor(0);
        // MathJax 渲染 block0 初始內容
        autoFitBlock0Font();
        if (window.MathJax) MathJax.typesetPromise([document.getElementById('blockContent')]).then(() => {
          autoFitBlock0Font();
        });
      } catch (e) {
        alert('JS Error: ' + e.message + '\n' + (e.stack||''));
      }
    }

    // Toggle the visibility of the entire block
    function toggleBlockVisibility(wrapperId) {
      const wrapper = document.getElementById(wrapperId);
      if (!wrapper) return;
      // If already hidden, restore
      if (wrapper.querySelector('.restore-block-btn')) {
        wrapper.innerHTML = wrapper._originalContent;
        bindHelpButtons(wrapper);
        return;
      }
      // Save original content
      if (!wrapper._originalContent) {
        wrapper._originalContent = wrapper.innerHTML;
      }
      // Get block label
      let label = wrapper.querySelector('.block-label')?.textContent || '';
      wrapper.innerHTML = `<button class='restore-block-btn' onclick='toggleBlockVisibility("${wrapperId}")'>顯示${label}</button>`;
    }

    // ===== Schrodinger picture data/functions from prototype.html =====
    const schGates = [
      {row:0, col:1, type:'I', color:'#c9b18a'},
      {row:0, col:2, type:'I', color:'#c9b18a'},
      {row:0, col:3, type:'U', color:'#f24d4d'},
      {row:0, col:4, type:'●', color:'#FFC94A'},
      {row:0, col:5, type:'H', color:'#73C7F3'},
      {row:0, col:6, type:'I', color:'#c9b18a'},
      {row:0, col:7, type:'I', color:'#c9b18a'},
      {row:0, col:8, type:'●', color:'#FFC94A'},
      {row:0, col:9, type:'I', color:'#c9b18a'},

      {row:1, col:1, type:'H', color:'#73C7F3'},
      {row:1, col:2, type:'●', color:'#FFC94A'},
      {row:1, col:3, type:'I', color:'#c9b18a'},
      {row:1, col:4, type:'X', color:'#FFC94A'},
      {row:1, col:5, type:'I', color:'#c9b18a'},
      {row:1, col:6, type:'●', color:'#FFC94A'},
      {row:1, col:7, type:'I', color:'#c9b18a'},
      {row:1, col:8, type:'I', color:'#c9b18a'},
      {row:1, col:9, type:'I', color:'#c9b18a'},

      {row:2, col:1, type:'I', color:'#c9b18a'},
      {row:2, col:2, type:'X', color:'#FFC94A'},
      {row:2, col:3, type:'I', color:'#c9b18a'},
      {row:2, col:4, type:'I', color:'#c9b18a'},
      {row:2, col:5, type:'I', color:'#c9b18a'},
      {row:2, col:6, type:'X', color:'#FFC94A'},
      {row:2, col:7, type:'H', color:'#73C7F3'},
      {row:2, col:8, type:'X', color:'#FFC94A'},
      {row:2, col:9, type:'H', color:'#73C7F3'},
    ];
    const schGates2 = [
      {row:0, col:1, type:'━━━', color:'#fffff0'},
      {row:0, col:2, type:'━━━', color:'#fffff0'},
      {row:0, col:3, type:'U', color:'#f24d4d'},
      {row:0, col:4, type:'●', color:'#FFC94A'},
      {row:0, col:5, type:'H', color:'#73C7F3'},
      {row:0, col:6, type:'━━━', color:'#fffff0'},
      {row:0, col:7, type:'━━━', color:'#fffff0'},
      {row:0, col:8, type:'●', color:'#FFC94A'},
      {row:0, col:9, type:'━━➤', color:'#fffff0'},

      {row:1, col:1, type:'H', color:'#73C7F3'},
      {row:1, col:2, type:'●', color:'#FFC94A'},
      {row:1, col:3, type:'━━━', color:'#fffff0'},
      {row:1, col:4, type:'X', color:'#FFC94A'},
      {row:1, col:5, type:'━━━', color:'#fffff0'},
      {row:1, col:6, type:'●', color:'#FFC94A'},
      {row:1, col:7, type:'━━━', color:'#fffff0'},
      {row:1, col:8, type:'━━━', color:'#fffff0'},
      {row:1, col:9, type:'━━➤', color:'#fffff0'},

      {row:2, col:1, type:'━━━', color:'#fffff0'},
      {row:2, col:2, type:'X', color:'#FFC94A'},
      {row:2, col:3, type:'━━━', color:'#fffff0'},
      {row:2, col:4, type:'━━━', color:'#fffff0'},
      {row:2, col:5, type:'━━━', color:'#fffff0'},
      {row:2, col:6, type:'X', color:'#FFC94A'},
      {row:2, col:7, type:'H', color:'#73C7F3'},
      {row:2, col:8, type:'X', color:'#FFC94A'},
      {row:2, col:9, type:'H', color:'#73C7F3'},
    ];
    const schStates = [
      '\\[|\\Psi_0\\rangle = |000\\rangle\\]',
      '\\[|\\Psi_1\\rangle = \\frac{1}{\\sqrt{2}}\\left(|000\\rangle +|010\\rangle\\right)\\]',
      '\\[|\\Psi_2\\rangle = \\frac{1}{\\sqrt{2}}\\left(|000\\rangle +|011\\rangle\\right)\\]',
      '\\[\\begin{align*}' +'|\\Psi_3\\rangle &= \\frac{1}{\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |011\\rangle \\\\ ' +
             '&\\qquad + \\beta |100\\rangle + \\beta |111\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\Psi_4\\rangle &= \\frac{1}{\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |011\\rangle \\\\ ' +
             '&\\qquad + \\beta |110\\rangle + \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\Psi_5\\rangle &= \\frac{1}{2}\\Big[\\alpha |000\\rangle + \\alpha |100\\rangle + \\alpha |011\\rangle +\\alpha |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |110\\rangle + \\beta |001\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\Psi_6\\rangle &= \\frac{1}{2}\\Big[\\alpha |000\\rangle + \\alpha |100\\rangle + \\alpha |010\\rangle +\\alpha |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |011\\rangle - \\beta |111\\rangle + \\beta |001\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\Psi_7\\rangle &= \\frac{1}{2\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |001\\rangle + \\alpha |100\\rangle +\\alpha |101\\rangle \\\\ ' +
             '&\\qquad + \\alpha |010\\rangle + \\alpha |011\\rangle + \\alpha |110\\rangle +\\alpha |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |011\\rangle - \\beta |110\\rangle + \\beta |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |000\\rangle - \\beta |001\\rangle - \\beta |100\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\Psi_8\\rangle &= \\frac{1}{2\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |001\\rangle + \\alpha |101\\rangle +\\alpha |100\\rangle \\\\ ' +
             '&\\qquad + \\alpha |010\\rangle + \\alpha |011\\rangle + \\alpha |111\\rangle +\\alpha |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |011\\rangle - \\beta |111\\rangle + \\beta |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |000\\rangle - \\beta |001\\rangle - \\beta |101\\rangle - \\beta |100\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[|\\Psi_9\\rangle = \\frac{1}{2}\\left(|00\\rangle +|10\\rangle + |01\\rangle +|11\\rangle\\right)\\otimes \\left(\\alpha |0\\rangle +\\beta |1\\rangle\\right)\\]',
    ];
    const psiInfo = [
      'Ψ₀', 'Ψ₁', 'Ψ₂', 'Ψ₃', 'Ψ₄', 'Ψ₅', 'Ψ₆', 'Ψ₇', 'Ψ₈', 'Ψ₉'
    ];
    const UInfo = [
      'Q(0)', 'Q(1)', 'Q(2)', 'Q(3)', 'Q(4)', 'Q(5)', 'Q(6)', 'Q(7)', 'Q(8)', 'Q(9)'
    ];
    function colorAlphaBeta(latex) {
      return latex
        .replace(/\\alpha/g, '{\\color{red}{\\alpha}}')
        .replace(/\\beta/g, '{\\color{red}{\\beta}}');
    }
    function initGridSch() {
      const grid = document.getElementById('grid-sch');
      if (!grid) return;
      grid.innerHTML = '';
      let lookup = {};
      schGates2.forEach(g=>{ lookup[`${g.row},${g.col}`] = g; });
      // 預先找出每個col的CNOT組合
      window.cnotCols = {};
      for (let col = 0; col < 11; col++) {
        let dotRow = -1, plusRow = -1;
        for (let row = 0; row < 3; row++) {
          const g = lookup[`${row},${col}`];
          if (g && g.type === '●') dotRow = row;
          if (g && g.type === 'X') plusRow = row;
        }
        if (dotRow !== -1 && plusRow !== -1) {
          window.cnotCols[col] = {dotRow, plusRow};
        }
      }
      // SVG helpers
      function svgWire(gateSVG = '', color = '#39382c') {
        return `<svg width="100%" height="100%" viewBox="-4 -8 40 48" style="overflow:visible">
          <line x1="-16" y1="16" x2="48" y2="16" stroke="${color}" stroke-width="2"/>
          ${gateSVG}
        </svg>`;
      }
      function svgDotWithWire(connectDown = false) {
        return svgWire(`
          <circle cx="16" cy="16" r="5" fill="black"/>
          ${connectDown ? '<line x1="16" y1="16" x2="16" y2="48" stroke="black" stroke-width="2"/>' : ''}
        `);
      }
      function svgPlusWithWire(connectUp = false) {
        return svgWire(`
          <circle cx="16" cy="16" r="9" fill="white" stroke="black" stroke-width="2"/>
          <line x1="16" y1="8" x2="16" y2="24" stroke="black" stroke-width="2"/>
          <line x1="8" y1="16" x2="24" y2="16" stroke="black" stroke-width="2"/>
          ${connectUp ? '<line x1="16" y1="-16" x2="16" y2="16" stroke="black" stroke-width="2"/>' : ''}
        `);
      }
      function svgIWithWire(color) {
        return svgWire(`
          <line x1="0" y1="16" x2="32" y2="16" stroke="#000" stroke-width="2"/>
        `, color);
      }
      for (let row = 0; row < 4; row++) {
        for (let col = 0; col < 11; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `grid-sch-r${row}c${col}`;
          if (row === 3) {
            cell.classList.add('invisible-cell');
          } else {
            if (col === 0) cell.textContent = '|0⟩';
            if (lookup[`${row},${col}`]) {
              const type = lookup[`${row},${col}`].type;
              cell.classList.add('gate');
              cell.dataset.color = lookup[`${row},${col}`].color;
              cell.style.background = lookup[`${row},${col}`].color;
              cell.style.color = '#222';
              cell.style.opacity = '1';
              // SVG gate化
              if (row === 1 && col === 8) {
                // 十字線SVG
                cell.innerHTML = `
                  <svg width="100%" height="100%" viewBox="-4 -8 40 48" style="overflow:visible">
                    <line x1="-12" y1="16" x2="48" y2="16" stroke="#000" stroke-width="2"/>
                    <line x1="16" y1="-8" x2="16" y2="40" stroke="#000" stroke-width="2"/>
                  </svg>`;
              } else if ((col === 9) && (row === 0 || row === 1)) {
                // 橫線+右箭頭SVG
                cell.innerHTML = `
                  <svg width="100%" height="100%" viewBox="-4 -8 40 48" style="overflow:visible">
                    <line x1="-10" y1="16" x2="48" y2="16" stroke="#000" stroke-width="2"/>
                    <polygon points="48,16 42,12 42,20" fill="#000"/>
                  </svg>`;
              } else if (type === 'I' || type === '━━━' || type === '━━➤') {
                // 只畫橫線SVG
                cell.innerHTML = `
                  <svg width="100%" height="100%" viewBox="-4 -8 40 48" style="overflow:visible">
                    <line x1="-10" y1="16" x2="48" y2="16" stroke="#000" stroke-width="2"/>
                  </svg>`;
              } else if (type === '●') {
                if (col !== 0 && col !== 10) {
                  cell.innerHTML = svgDotWithWire(window.cnotCols[col] && window.cnotCols[col].dotRow === row);
                } else {
                  cell.innerHTML = '<svg width="32" height="32"><circle cx="16" cy="16" r="5" fill="black"/></svg>';
                }
              } else if (type === 'X') {
                if (col !== 0 && col !== 10) {
                  cell.innerHTML = svgPlusWithWire(window.cnotCols[col] && window.cnotCols[col].plusRow === row);
                } else {
                  cell.innerHTML = `<svg width="32" height="32">
                    <circle cx="16" cy="16" r="9" fill="white" stroke="black" stroke-width="2"/>
                    <line x1="16" y1="8" x2="16" y2="24" stroke="black" stroke-width="2"/>
                    <line x1="8" y1="16" x2="24" y2="16" stroke="black" stroke-width="2"/>
                  </svg>`;
                }
              } else if (type === 'I') {
                // I gate用十字SVG（橫線+豎線，線條顏色黑色）
                cell.innerHTML = `
                  <svg width="100%" height="100%" viewBox="-4 -8 40 48" style="overflow:visible">
                    <line x1="-10" y1="16" x2="48" y2="16" stroke="#000" stroke-width="2"/>
                    <line x1="16" y1="-8" x2="16" y2="40" stroke="#000" stroke-width="2"/>
                  </svg>`;
              } else if (type === '━━━' || type === '━━➤') {
                // 橫線SVG（和I gate一樣，橫線+豎線，線條顏色黑色）
                cell.innerHTML = `
                  <svg width="100%" height="100%" viewBox="-4 -8 40 48" style="overflow:visible">
                    <line x1="-10" y1="16" x2="48" y2="16" stroke="#000" stroke-width="2"/>
                    <line x1="16" y1="-8" x2="16" y2="40" stroke="#000" stroke-width="2"/>
                  </svg>`;
              } else {
                // 其他 gate（如 H/U/●/X 以外）維持原本設計
                cell.textContent = type;
              }
              // type 為 '━━━' 或 '━━━➤' 時，border 顏色設為 #fffff0
              if (type === '━━━' || type === '━━➤') {
                cell.style.borderColor = '#fffff0';
              }
            }
            if (col === 10) cell.classList.add('invisible-cell');
          }
          grid.appendChild(cell);
        }
      }
      // Record the left position of each col (based on the first row)
      window.gridCellLefts = [];
      for (let col = 0; col < 11; col++) {
        const cell = document.getElementById(`grid-sch-r0c${col}`);
        if (cell) {
          window.gridCellLefts[col] = cell.offsetLeft;
        }
      }
      fitGridToBlock('block2-block', 'grid-sch');
    }
    function updateSchrodingerGrid(t) {
      // grid highlight
      for (let row = 0; row < 4; row++) {
        for (let col = 0; col < 11; col++) {
          let sch = document.getElementById(`grid-sch-r${row}c${col}`);
          if (sch && sch.classList.contains('gate')) {
            // 預設移除高亮
            sch.classList.remove('highlight');
            sch.style.background = sch.dataset.color;
            sch.style.color = '#222';

            // CNOT 高亮
            if (col === t && window.cnotCols && window.cnotCols[col] &&
                (row === window.cnotCols[col].dotRow || row === window.cnotCols[col].plusRow)) {
              sch.classList.add('highlight');
              sch.style.background = sch.dataset.color;
              sch.style.color = '#fff';
            }
            // H/U 高亮（H: #73C7F3, U: #f24d4d）
            else if (col === t && sch.dataset && (sch.dataset.color === '#73C7F3' || sch.dataset.color === '#f24d4d')) {
              sch.classList.add('highlight');
              sch.style.background = sch.dataset.color;
              sch.style.color = '#fff';
            }
          }
        }
      }
      // Control the display of the bottom row (row=3) cells
      for (let col = 0; col < 11; col++) {
        let cell = document.getElementById(`grid-sch-r3c${col}`);
        if (!cell) continue;
        if (col === t) {
          cell.classList.remove('invisible-cell');
          cell.textContent = psiInfo[t] || '';
          cell.style.background = '#2166c2';
          cell.style.color = '#fff';
          cell.style.opacity = '1';
          cell.style.fontWeight = 'bold';
        } else {
          cell.classList.add('invisible-cell');
          cell.textContent = '';
          cell.style.background = '';
          cell.style.color = '';
          cell.style.opacity = '';
          cell.style.fontWeight = '';
        }
      }
      fitGridToBlock('block2-block', 'grid-sch');
      // 額外 log cnotCols 狀態
      console.log('cnotCols:', window.cnotCols);
    }
    function initGridHei() {
      const grid = document.getElementById('grid-hei');
      if (!grid) return;
      grid.innerHTML = '';
      let lookup = {};
      schGates.forEach(g=>{ lookup[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 4; row++) {
        for (let col = 0; col < 11; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `grid-hei-r${row}c${col}`;
          if (row === 3) {
            cell.classList.add('invisible-cell');
          } else {
            if (col === 0) cell.textContent = '|0⟩';
            if (col === 10) cell.classList.add('invisible-cell');
          }
          grid.appendChild(cell);
        }
      }
      fitGridToBlock('block4-block', 'grid-hei');
    }
    function updateHeisenbergGrid(t) {
      let gateMap = {};
      schGates.forEach(g => { gateMap[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 11; col++) {
          let hei = document.getElementById(`grid-hei-r${row}c${col}`);
          if (!hei) continue;
          if (col === 0 || col === 10) {
            hei.textContent = '|0⟩';
            hei.style.background = '#222';
            hei.style.color = '#c9b18a';
            hei.style.opacity = 1;
            hei.classList.remove('highlight');
          } else if (gateMap[`${row},${col}`]) {
            if (col <= t) {
              hei.textContent = gateMap[`${row},${col}`].type;
              hei.classList.add('gate');
              hei.style.background = gateMap[`${row},${col}`].color;
              hei.style.color = '#fff';
              hei.style.opacity = 1;
              // t 以前（含 t）的 cell 都加 highlight
              hei.classList.add('highlight');
            } else {
              hei.textContent = '';
              hei.classList.remove('gate');
              hei.classList.remove('highlight');
              hei.style.background = '#222';
              hei.style.color = '#222';
              hei.style.opacity = 1;
            }
          } else {
            hei.textContent = '';
            hei.classList.remove('highlight');
            hei.style.background = '#222';
            hei.style.color = '#222';
            hei.style.opacity = 1;
          }
        }
      }
      // Control the display of the bottom row (row=3) cells
      for (let col = 0; col < 11; col++) {
        let cell = document.getElementById(`grid-hei-r3c${col}`);
        if (!cell) continue;
        if (col === t) {
          cell.classList.remove('invisible-cell');
          cell.textContent = UInfo[t] || '';
          cell.classList.add('active-ut');
        } else {
          cell.classList.add('invisible-cell');
          cell.textContent = '';
          cell.classList.remove('active-ut');
        }
      }
      fitGridToBlock('block4-block', 'grid-hei');
    }
    // --- Pauli expectation migrated ---
    const pauliExpectationData = [
      { q1: "(0,1)", q2: "(0,1)", q3: "(0,1)" },//t=0
      { q1: "(0,1)", q2: "(1,0)", q3: "(0,1)" },//t=1
      { q1: "(0,1)", q2: "(0,0)", q3: "(0,0)" },//t=2
      { q1: "(2αβ,α²-β²)", q2: "(0,0)", q3: "(0,0)" },//t=3
      { q1: "(0,α²-β²)", q2: "(0,0)", q3: "(0,0)" },//t=4
      { q1: "(α²-β²,0)", q2: "(0,0)", q3: "(0,0)" },//t=5
      { q1: "(α²-β²,0)", q2: "(1,0)", q3: "(0,α²-β²)" },//t=6
      { q1: "(α²-β²,0)", q2: "(1,0)", q3: "(α²-β²,0)" },//t=7
      { q1: "(1,0)", q2: "(1,0)", q3: "(α²-β²,2αβ)" },//t=8
      { q1: "(1,0)", q2: "(1,0)", q3: "(2αβ,α²-β²)" },//t=9
    ];
    function pauliValToColor(val) {
      if (!isNaN(val)) {
        val = parseFloat(val);
        const strength = Math.min(1, Math.abs(val));
        if (val > 0) return `rgba(115, 199, 243, ${strength})`;  // 藍
        if (val < 0) return `rgba(242, 77, 77, ${strength})`;    // 紅
      }
      if (typeof val === 'string') {
        if (val.includes('α') || val.includes('β')) {
          return '#f24d4d';  // Red represents containing α² - β², etc.
        }
      }
      return "#222";  // Use dark background for non-numeric values
    }
    function pauliFormat(val) {
      if (!isNaN(val)) {
        val = parseFloat(val);
        return (val >= 0 ? '+' : '') + val.toFixed(2);
      }
      return val;
    }
    function extractPair(val) {
      if (typeof val === 'string' && val.startsWith('(')) {
        const [left, right] = val.replace(/[()]/g, '').split(',');
        return [left, right];
      }
      return [val, val];
    }
    function updatePauliExpectation(t) {
      const expect = pauliExpectationData[t] || {q1: 0, q2: 0, q3: 0};
      ['q1', 'q2', 'q3'].forEach((q, i) => {
        const [left, right] = extractPair(expect[q]);
        document.getElementById(`pauli-q${i+1}-left`).textContent = pauliFormat(left);
        document.getElementById(`pauli-q${i+1}-right`).textContent = pauliFormat(right);
        document.getElementById(`pauli-q${i+1}-left`).style.background = pauliValToColor(left);
        document.getElementById(`pauli-q${i+1}-right`).style.background = pauliValToColor(right);
      });
    }
    // 新增：block3 quantum state 顯示
    function updateBlock3QuantumState(t) {
      var el = document.getElementById('block3-quantum-state');
      if (!el) return;
      el.innerHTML = colorAlphaBeta(schStates[t] || '');
      if (window.MathJax) {
        MathJax.typesetPromise([el]).then(() => {
          fitBlock3QuantumStateFont();
        });
      } else {
        fitBlock3QuantumStateFont();
      }
    }

    // Automatically scale font size until content fits within block3
    function fitBlock3QuantumStateFont() {
      const el = document.getElementById('block3-quantum-state');
      const wrapper = document.getElementById('block3');
      if (!el || !wrapper) return;
      let minFont = 10; // px
      let maxFont = 32; // px
      let fontSize = maxFont;
      el.style.fontSize = fontSize + 'px';
      // If it fits at the start, just return
      if (el.scrollWidth <= wrapper.clientWidth) return;
      let iter = 0;
      let maxIter = 50;
      while (el.scrollWidth > wrapper.clientWidth && fontSize > minFont && iter < maxIter) {
        fontSize -= 1;
        el.style.fontSize = fontSize + 'px';
        iter++;
      }
      // If still overflowing, set to minFont
      if (el.scrollWidth > wrapper.clientWidth) {
        el.style.fontSize = minFont + 'px';
      }
    }

    // descriptorData from prototype.html
    const descriptorData = [
      //t=0
      [
        { label: 'q₁(0)', ops: [
          { text: 'σ₁x', class: 'desc-s1' }, 
          { text: ',', class: 'desc-comma' }, { text: 'σ₁z', class: 'desc-s1' }
        ]},
        { label: 'q₂(0)', ops: [
          { text: 'σ₂x', class: 'desc-s2' }, 
          { text: ',', class: 'desc-comma' }, { text: 'σ₂z', class: 'desc-s2' }
        ]},
        { label: 'q₃(0)', ops: [
          { text: 'σ₃x', class: 'desc-s3' }, 
          { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }
        ]}
      ],
      // t=1
      [
        { label: 'q₁(1)', ops: [
          { text: 'σ₁x', class: 'desc-s1' }, 
          { text: ',', class: 'desc-comma' }, { text: 'σ₁z', class: 'desc-s1' }
        ]},
        { label: 'q₂(1)', ops: [
          { text: 'σ₂z', class: 'desc-s2' }, 
          { text: ',', class: 'desc-comma' }, { text: 'σ₂x', class: 'desc-s2' }
        ]},
        { label: 'q₃(1)', ops: [
          { text: 'σ₃x', class: 'desc-s3' }, 
          { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }
        ]}
      ],
      // t=2
      [
       { label: 'q₁(2)', ops: [
          { text: 'σ₁x', class: 'desc-s1' }, 
          { text: ',', class: 'desc-comma' }, { text: 'σ₁z', class: 'desc-s1' }
        ]},
       { label: 'q₂(2)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
         { text: ',', class: 'desc-comma' },{ text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(2)', ops: [
         { text: 'σ₃x', class: 'desc-s3' }, 
         { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
       ]}
      ],
      //t=3
      [
       { label: 'q₁(3)', ops: [
          { text: 'D₁x', class: 'desc-s4' }, 
          { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }
        ]},
       { label: 'q₂(3)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
         { text: ',', class: 'desc-comma' },{ text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(3)', ops: [
         { text: 'σ₃x', class: 'desc-s3' }, 
         { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
       ]}
      ],
      //t=4
      [
       { label: 'q₁(4)', ops: [
          { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
          { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }
        ]},
       { label: 'q₂(4)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
         { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(4)', ops: [
         { text: 'σ₃x', class: 'desc-s3' }, 
         { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
       ]}
      ],
      //t=5
      [
       { label: 'q₁(5)', ops: [
       { text: 'D₁z', class: 'desc-s4' },
          { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
        ]},
       { label: 'q₂(5)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
         { text: ',', class: 'desc-comma' }, 
         { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(5)', ops: [
         { text: 'σ₃x', class: 'desc-s3' }, 
         { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
       ]}
      ],
      //t=6
      [
       { label: 'q₁(6)', ops: [
       { text: 'D₁z', class: 'desc-s4' },
          { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
        ]},
       { label: 'q₂(6)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },
         { text: ',', class: 'desc-comma' }, 
         { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(6)', ops: [
         { text: 'σ₃x', class: 'desc-s3' }, 
         { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' },
       ]}
      ],
      //t=7
      [
       { label: 'q₁(7)', ops: [
       { text: 'D₁z', class: 'desc-s4' },
          { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
        ]},
       { label: 'q₂(7)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },
         { text: ',', class: 'desc-comma' }, 
         { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(7)', ops: [
       { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' },
         { text: ',', class: 'desc-comma' }, { text: 'σ₃x', class: 'desc-s3' }
       ]}
      ],
      //t=8
      [
       { label: 'q₁(8)', ops: [
          { text: 'σ₃z', class: 'desc-s3' },
          { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
        ]},
       { label: 'q₂(8)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },
         { text: ',', class: 'desc-comma' }, 
         { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(8)', ops: [
       { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' },
         { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' }
       ]}
      ],
      //t=9
      [
       { label: 'q₁(8)', ops: [
          { text: 'σ₃z', class: 'desc-s3' },
          { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
        ]},
       { label: 'q₂(8)', ops: [
         { text: 'σ₂z', class: 'desc-s2' },
         { text: ',', class: 'desc-comma' }, 
         { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
       ]},
       { label: 'q₃(8)', ops: [
         { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },
         { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' }
       ]}
      ],
    ];

    // Style for descriptor
    const descStyle = document.createElement('style');
    descStyle.innerHTML = `
      .desc-state-row { font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace; font-size: 1.12em; color: #2f4f78; margin-bottom: 4px; line-height: 1.8; padding-left: 3px; justify-content: flex-start; align-items: center; display: flex; width: 100%; }
      .desc-label2 { color: #9fdcf9; font-weight: bold; margin-right: 2px; letter-spacing: .5px; font-size: 1.05em; }
      .desc-equal { color: #eee0a2; margin: 0 7px 0 3px; font-weight: bold; }
      .desc-op { font-weight: bold; margin-right: 5px; display: inline-block; text-align: center; }
      .desc-s1 { color: gold; }
      .desc-s2 { color: deepskyblue; }
      .desc-s3 { color: magenta; }
      .desc-s4 { color: red; }
      .desc-comma { color: #a8a8a8; margin: 0 6px 0 2px; font-weight: bold; }
    `;
    document.head.appendChild(descStyle);

    function renderDescriptor(t) {
      const block = document.getElementById('block6-descriptor');
      block.innerHTML = '';
      const list = descriptorData[t] || [];
      for (let item of list) {
        const row = document.createElement('div');
        row.className = 'desc-state-row';
        // Label
        const label = document.createElement('span');
        label.className = 'desc-label2';
        label.textContent = item.label;
        row.appendChild(label);
        // Equal sign
        const eq = document.createElement('span');
        eq.className = 'desc-equal';
        eq.textContent = '=';
        row.appendChild(eq);
        // Iterate symbols
        item.ops.forEach((op) => {
          const opSpan = document.createElement('span');
          opSpan.className = 'desc-op ' + op.class;
          opSpan.innerHTML = op.text;
          row.appendChild(opSpan);
        });
        block.appendChild(row);
      }
      if (list.length === 0) {
        block.innerHTML = '<span class="desc-label">No descriptor at this step.</span>';
      }
    }

    function fitBlock6DescriptorFont() {
      const el = document.getElementById('block6-descriptor');
      const wrapper = document.getElementById('block6-block');
      if (!el || !wrapper) return;
      let minFont = 10; // px
      let maxFont = 22; // px
      let fontSize = maxFont;
      el.style.fontSize = fontSize + 'px';
      if (el.scrollWidth <= wrapper.clientWidth) return;
      let iter = 0;
      let maxIter = 50;
      while (el.scrollWidth > wrapper.clientWidth && fontSize > minFont && iter < maxIter) {
        fontSize -= 1;
        el.style.fontSize = fontSize + 'px';
        iter++;
      }
      if (el.scrollWidth > wrapper.clientWidth) {
        el.style.fontSize = minFont + 'px';
      }
    }

    function updateBlock6Descriptor(t) {
      renderDescriptor(t);
      fitBlock6DescriptorFont();
    }

    // block0 字體自動隨 block0 寬度縮放
    function autoFitBlock0Font() {
      const wrapper = document.getElementById('block0');
      const el = document.getElementById('blockContent');
      if (!wrapper || !el) return;
      const minFont = 12;   // 最小字體大小（單位：px）
      const maxFont = 36;   // 最大字體大小（單位：px）
      const scale = 0.05;  // 字體大小與 block0 寬度的比例
      let fontSize = Math.max(minFont, Math.min(maxFont, wrapper.clientWidth * scale));
      el.style.fontSize = fontSize + 'px';
    }
    // 初始化 observer
    window.addEventListener('DOMContentLoaded', () => {
      autoFitBlock0Font();
      const block0 = document.getElementById('block0');
      if (block0) {
        const observer = new ResizeObserver(autoFitBlock0Font);
        observer.observe(block0);
      }
    });

    // ====== 新增：自適應 grid 函數 ======
    function fitGridToBlock(blockId, gridId) {
      const block = document.getElementById(blockId);
      const grid = document.getElementById(gridId);
      if (!block || !grid) return;
      // 取得 block 寬度
      const blockWidth = block.clientWidth;
      // 計算 cell 大小（11 col, 4 row, gap 0.2vw）
      const gap = blockWidth * 0.003; // 0.2vw 近似
      const cellSize = (blockWidth - gap * 10) / 11;
      // 設定 cell 寬高與字體
      grid.querySelectorAll('.cell').forEach(cell => {
        cell.style.width = cellSize + 'px';
        cell.style.height = cellSize + 'px';
        cell.style.fontSize = Math.max(10, Math.min(24, cellSize * 0.38)) + 'px';
      });
      // grid 高度自動
      grid.style.height = (cellSize * 4 + gap * 3) + 'px';
    }
    function observeBlockResize(blockId, gridId) {
      const block = document.getElementById(blockId);
      if (!block) return;
      const ro = new ResizeObserver(() => fitGridToBlock(blockId, gridId));
      ro.observe(block);
    }
  </script>
</body>
</html>
