<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simulated Experiment</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      background-color: #2f4f78;
    }
    .tab {
      padding: 10px 20px;
      color: #333;
      background: #ccc;
      cursor: pointer;
    }
    .tab.active {
      background: #fff;
      font-weight: bold;
    }
    .container {
      display: none;
      height: calc(100% - 40px);
      padding: 10px;
      box-sizing: border-box;
    }
    .container.active {
      display: grid;
      /* grid-template-columns: 32% 34% 32%; */
      grid-template-columns: 32% 40% 28%; /* block2/4寬一點，block3/6窄一點 */
      grid-template-rows: 32% 32% 34%;
      gap: 5px;
      height: calc(100% - 40px);
      padding: 10px 20px 10px 10px; /* 右側間距加大 */
      box-sizing: border-box;
      background: none;
    }
    .block {
      position: relative;
      border: 1px solid #ccc;
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.15), 0 1.5px 4px 0 rgba(0,0,0,0.10);
      min-height: 40px;
      box-sizing: border-box;
      overflow: hidden;
    }
    .block-yellow {
      background-color: #ffe9b3;
    }
    .btn-top-left, .btn-help {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: #0051ba;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      line-height: 20px;
      cursor: pointer;
    }
    .btn-top-left {
      top: 5px;
      left: 5px;
    }
    .btn-help {
      top: 5px;
      right: 5px;
      border-radius: 50%;
    }

    .block.hidden {
      display: none;
    }

    /* Define block sizes in percentages */
    .block-size-1 { width: 32%; height: 30%; }
    .block-size-2 { width: 32%; height: 30%; }
    .block-size-3 { width: 32%; height: 30%; }
    .block-size-4 { width: 32%; height: 30%; }
    .block-size-5 { width: 32%; height: 30%; }
    .block-size-6 { width: 98%; height: 30%; }

    .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }

    .column {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
    }
    .column-left {
      width: 32%;
    }
    .column-center {
      width: 32%;
    }
    .column-right {
      width: 32%;
    }
    .block-size-left-top {
      height: 60%;
    }
    .block-size-left-bottom {
      height: 38%;
    }
    .block-size-center-top {
      height: 30%;
    }
    .block-size-center-middle {
      height: 30%;
      margin: 10px 0;
    }
    .block-size-center-bottom {
      height: 38%;
    }
    .block-size-right-top {
      height: 48%;
    }
    .block-size-right-bottom {
      height: 48%;
    }
    .block {
      margin-bottom: 0;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      min-height: 40px;
      box-sizing: border-box;
    }
    .column > .block:not(:last-child) {
      margin-bottom: 2%;
    }

    /* Block位置對應圖片 */
    #block0 { grid-column: 1 / 2; grid-row: 1 / 3; background-color: #fffff0; }
    #block1 { grid-column: 1 / 2; grid-row: 3 / 4; background-color: #ffe9b3; }
    #block2 { grid-column: 2 / 3; grid-row: 1 / 2; background-color: #fffff0; }
    #block6 { grid-column: 2 / 3; grid-row: 2 / 3; background-color: #fffff0; }
    #block3 { grid-column: 3 / 4; grid-row: 1 / 2; background-color: #ffe9b3; }
    #block4 { grid-column: 3 / 4; grid-row: 2 / 3; background-color: #ffe9b3; }
    #block5 { grid-column: 2 / 4; grid-row: 3 / 4; background-color: #fffff0; }

    .block-label {
      position: absolute;
      top: 6px;
      left: 10px;
      background: rgba(255,255,255,0.85);
      color: #2f4f78;
      font-size: 15px;
      font-weight: bold;
      padding: 1px 8px;
      border-radius: 8px;
      z-index: 2;
      pointer-events: none;
    }

    .btn-bottom-right {
      position: absolute;
      right: 5px;
      bottom: 5px;
      width: 20px;
      height: 20px;
      background-color: #0051ba;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      line-height: 20px;
      cursor: pointer;
      border-radius: 3px;
      z-index: 2;
    }

    .block-content-hidden {
      display: none;
    }

    .restore-block-btn {
      width: 100%;
      height: 100%;
      min-height: 40px;
      background: #f5f7fa;
      color: #2f4f78;
      border: 2px dashed #2f4f78;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    #block6-block { background-color: #ffe9b3; }
    #block3-block { background-color: #ffe9b3; }

    .simple-slider-container {
      position: absolute;
      left: 18px;
      width: 66%;
      bottom: 18px;
      height: 32px;
      display: flex;
      align-items: flex-end;
      pointer-events: none;
    }
    .simple-slider-track {
      width: 100%;
      height: 4px;
      background: #4a5568;
      border-radius: 2px;
      position: relative;
      pointer-events: auto;
    }
    .simple-slider-thumb {
      position: absolute;
      top: 50%;
      left: 0%;
      width: 18px;
      height: 18px;
      background: #4e87d1;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transform: translate(-50%, -50%);
      cursor: pointer;
      z-index: 2;
      pointer-events: auto;
      transition: box-shadow 0.2s;
    }
    .simple-slider-thumb:active {
      box-shadow: 0 0 0 3px #b3d1f7;
    }

    .simple-slider-label {
      position: absolute;
      left: 18px;
      bottom: 56px;
      font-size: 22px;
      color: #2f4f78;
      font-weight: bold;
      background: rgba(255,255,255,0.7);
      padding: 2px 10px;
      border-radius: 8px;
      z-index: 3;
      pointer-events: none;
    }

    #block5, #block5 * {
      user-select: none !important;
    }

    /* Schrodinger picture styles from prototype.html */
    .grid {
      display: grid;
      grid-template-columns: repeat(11, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 0.2vw;
      width: calc(100% - 20px);
      margin: 0 10px;
      min-width: 120px;
      margin-bottom: 50px;
    }
    .cell {
      width: 100%;
      height: auto;
      aspect-ratio: 1/1;
      background: #222;
      border: 1px solid #39382c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(0.9em, 1.5vw, 1.15em);
      font-family: 'Quicksand', 'Arial Rounded MT Bold', 'Poppins', 'circular', 'Segoe UI Rounded', 'Segoe UI', 'Arial', sans-serif;
      font-weight: 700;
      transition: background 0.2s, color 0.2s, opacity 0.2s;
      color: #c9b18a;
      opacity: 0.25;
    }
    .cell.gate { opacity: 1; color: #222; font-weight: bold; }
    .cell.gate.highlight {
      box-shadow: 0 0 18px 6px #fff, 0 0 0 2px #fff inset;
      color: #222;
      z-index: 2;
      font-size: 1.28em;
    }
    .cell.active {
      background: #6f5b3e;
      color: #fff7c9;
      opacity: 1;
      font-weight: bold;
    }
    .mini-cell-label {
      position: relative;
      width: 100%;
      max-width: 352px;
      min-width: 120px;
      height: auto;
      margin-top: 6px;
      margin-left: 0;
    }
    .mini-cell {
      /* width, height, font-size 由 JS 動態設置 */
      background: #222;
      border: 1px solid #39382c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #c9b18a;
      font-weight: bold;
      position: absolute;
      top: 0;
      left: 0;
      /* transition: left 0.3s, width 0.2s, height 0.2s, font-size 0.2s; */
    }
    #state-sch {
      min-height: 2em;
      color: #6fd8fc;
      margin-bottom: 6px;
      font-size: 0.8em;
      font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
      line-height: 1.6;
      word-break: break-word;
      overflow-y: auto;
      overflow-x: auto;
      height: 100%;
      padding-right: 8px;
    }
    .invisible-cell {
      visibility: hidden;
    }
    #block2-schrodinger {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 30px 10px 20px 3px;
    }
    #block4-heisenberg {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 30px 10px 20px 3px;
      background: #fffff0;
    }
    #grid-hei .cell {
      background: #e0c2c0;
      border: 1px solid #948778;
      color: #2f4f78;
    }
    #grid-hei .cell.invisible-cell {
      visibility: hidden;
    }
    #block4-heisenberg .grid .cell:not(.gate) {
      background: #e0d6c0 !important;
      border: 1px solid #312a20;
      color: #2f4f78;
    }
    #block4-heisenberg .grid .cell.gate.highlight {
      box-shadow: 0 0 18px 6px rgba(255,255,255,0.3), 0 0 0 2px rgba(255,255,255,0.25) inset;
      color: #222;
      z-index: 2;
      font-size: 1.28em;
    }
    #block4-heisenberg .grid .cell.active-ut {
      background: #2d5ec7 !important;
      color: #fff !important;
      opacity: 1 !important;
      font-weight: bold;
      border: 1px solid #39382c;
      border-radius: 4px;
      font-size: clamp(0.9em, 1.5vw, 1.15em);
      transition: background 0.2s, color 0.2s, opacity 0.2s;
      z-index: 2;
    }
    .simple-slider-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: #2d5ec7;
      margin-left: 8px;
      user-select: none;
      height: 32px;
    }
    .pauli-expect-block {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      margin-top: 10px;
      margin-bottom: 10px;
      gap: 10px;
      padding-left: 16px;
      padding-right: 16px;
    }
    .pauli-row {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      margin-bottom: 0;
    }
    .pauli-label {
      width: 2.5em;
      min-width: 2.5em;
      margin-left: 8px;
    }
    .pauli-box {
      flex: 1 1 0;
      min-width: 0;
      height: 28px;
      border: 1px solid #39382c;
      border-radius: 5px;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 0.98em;
      transition: background 0.2s;
    }
    #block1 {
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      height: 100%;
    }
    .pauli-expect-block {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      align-items: flex-start;
      height: 100%;
      margin: 0;
      gap: 0;
    }
    .pauli-row {
      margin-bottom: 0;
    }
    #block1 .block-label {
      margin-bottom: 0.8em;
      z-index: 1;
    }
    .pauli-expect-block {
      height: calc(100% - 2.5em);
    }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">Table 1</div>
    <div class="tab" onclick="switchTab(1)">Table 2</div>
  </div>

  <!-- Table 1 -->
  <div class="container active" id="tab0">
    <div class="block" id="block0">
      <div id="blockContent">Block 0 content...</div>
    </div>
    <div class="block" id="block1">
      <span class="block-label">Block1</span>
      <span class="btn-help">?</span>
      <div class="pauli-expect-block">
        <div class="pauli-row"><span class="pauli-label">Q₁</span><div class="pauli-box" id="pauli-q1-left"></div><div class="pauli-box" id="pauli-q1-right"></div></div>
        <div class="pauli-row"><span class="pauli-label">Q₂</span><div class="pauli-box" id="pauli-q2-left"></div><div class="pauli-box" id="pauli-q2-right"></div></div>
        <div class="pauli-row"><span class="pauli-label">Q₃</span><div class="pauli-box" id="pauli-q3-left"></div><div class="pauli-box" id="pauli-q3-right"></div></div>
      </div>
    </div>
    <div class="block" id="block2-block">
      <div id="block2" class="block-inner">
        <span class="block-label">Block 2</span>
        <!-- Schrodinger picture block start -->
        <div id="block2-schrodinger">
          <div class="grid" id="grid-sch"></div>
        </div>
        <!-- Schrodinger picture block end -->
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block2-block')" id="toggle-block2">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
    <div class="block" id="block3-block">
      <div id="block3" class="block-inner">
        <span class="block-label">Block 3</span>
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block3-block')" id="toggle-block3">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
    <div class="block" id="block4-block">
      <div id="block4" class="block-inner">
        <span class="block-label">Block 4</span>
        <!-- Heisenberg picture block start -->
        <div id="block4-heisenberg">
          <div class="grid" id="grid-hei"></div>
        </div>
        <!-- Heisenberg picture block end -->
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block4-block')" id="toggle-block4">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
    <div class="block" id="block5">
      <span class="block-label">Block 5</span>
      <span class="btn-help">?</span>
      <div class="simple-slider-label" id="slider-t-label">t=0</div>
      <div class="simple-slider-container">
        <div class="simple-slider-track">
          <div class="simple-slider-thumb"></div>
        </div>
        <div class="simple-slider-arrow">&#9654;</div>
      </div>
    </div>
    <div class="block" id="block6-block">
      <div id="block6" class="block-inner">
        <span class="block-label">Block 6</span>
        <span class="btn-bottom-right" onclick="toggleBlockVisibility('block6-block')" id="toggle-block6">▲</span>
        <span class="btn-help">?</span>
      </div>
    </div>
  </div>

  <!-- Table 2 -->
  <div class="container" id="tab1">
    <!-- Placeholder for future enhancement -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script>
    function switchTab(index) {
      const tabs = document.querySelectorAll('.tab');
      const containers = document.querySelectorAll('.container');
      tabs.forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        containers[i].classList.toggle('active', i === index);
      });
    }

    function hideBlock(id) {
      document.getElementById(id).classList.add('hidden');
    }

    // block內容對應
    const blockContents = {
      block1: 'Block 1 content...',
      block2: 'Block 2 content...',
      block3: 'Block 3 content...',
      block4: 'Block 4 content...',
      block5: 'Block 5 content...',
      block6: 'Block 6 content...'
    };
    function showBlockContent(blockId) {
      const content = document.getElementById("blockContent");
      content.textContent = blockContents[blockId] || 'Block 0 content...';
    }
    // 問號按鈕事件綁定（可重複呼叫）
    function bindHelpButtons(scope=document) {
      scope.querySelectorAll('.btn-help').forEach(btn => {
        btn.onclick = function(e) {
          e.stopPropagation();
          let block = btn.closest('.block-inner') || btn.closest('.block');
          if (block && block.id && block.id !== 'block0') {
            showBlockContent(block.id);
          }
        }
      });
    }
    function initSimpleSlider() {
      const track = document.querySelector('.simple-slider-track');
      const thumb = document.querySelector('.simple-slider-thumb');
      const tLabel = document.getElementById('slider-t-label');
      if (!track || !thumb || !tLabel) return;
      // 十個非線性點（0,1,2,3,4,5,6,7,8,9）
      const ticks = [0,1,2,3,4,5,6,7,8,9];
      const tickPercents = ticks.map((v,i,arr) => i/(arr.length-1));
      let valueIdx = 0;
      let currentT = 0;
      function setThumb(idx) {
        valueIdx = idx;
        currentT = idx;
        window.getCurrentT = () => currentT;
        thumb.style.left = (tickPercents[idx]*100) + '%';
        tLabel.textContent = 't=' + ticks[idx];
        // 新增：同步更新 block2 的 Schrodinger picture
        updateSchrodingerGrid(idx);
        // 新增：同步更新 block4 的 Heisenberg picture
        updateHeisenbergGrid(idx);
        // 新增：同步更新 block1 的 Pauli expectation
        updatePauliExpectation(idx);
      }
      setThumb(0);
      let dragging = false;
      let trackRect = null;
      function preventSelection(e) {
        e.preventDefault();
        return false;
      }
      thumb.onmousedown = function(e) {
        dragging = true;
        trackRect = track.getBoundingClientRect();
        document.body.style.userSelect = 'none';
        document.addEventListener('selectstart', preventSelection);
      };
      document.addEventListener('mousemove', function(e) {
        if (!dragging) return;
        let x = e.clientX - trackRect.left;
        x = Math.max(0, Math.min(x, trackRect.width));
        let percent = x / trackRect.width;
        // snap to 最近的 tick
        let idx = tickPercents.reduce((prev, curr, i) => Math.abs(curr-percent)<Math.abs(tickPercents[prev]-percent)?i:prev, 0);
        setThumb(idx);
      });
      document.addEventListener('mouseup', function(e) {
        dragging = false;
        document.body.style.userSelect = '';
        document.removeEventListener('selectstart', preventSelection);
      });
      // 點擊軌道也能移動
      track.onclick = function(e) {
        if (e.target === thumb) return;
        trackRect = track.getBoundingClientRect();
        let x = e.clientX - trackRect.left;
        x = Math.max(0, Math.min(x, trackRect.width));
        let percent = x / trackRect.width;
        let idx = tickPercents.reduce((prev, curr, i) => Math.abs(curr-percent)<Math.abs(tickPercents[prev]-percent)?i:prev, 0);
        setThumb(idx);
      };
    }
    window.onload = function() {
      bindHelpButtons();
      initSimpleSlider();
      // 初始化 block2 的 Schrodinger picture
      initGridSch();
      updateSchrodingerGrid(0);
      // 初始化 block4 的 Heisenberg picture
      initGridHei();
      updateHeisenbergGrid(0);
      // 初始化 block1 的 Pauli expectation（移到最後，確保DOM已渲染）
      setTimeout(() => updatePauliExpectation(0), 0);
    }

    // 切換整個 block 顯示/隱藏
    function toggleBlockVisibility(wrapperId) {
      const wrapper = document.getElementById(wrapperId);
      if (!wrapper) return;
      // 如果已經隱藏，恢復
      if (wrapper.querySelector('.restore-block-btn')) {
        wrapper.innerHTML = wrapper._originalContent;
        bindHelpButtons(wrapper);
        return;
      }
      // 儲存原始內容
      if (!wrapper._originalContent) {
        wrapper._originalContent = wrapper.innerHTML;
      }
      // 取得 block label
      let label = wrapper.querySelector('.block-label')?.textContent || '';
      wrapper.innerHTML = `<button class='restore-block-btn' onclick='toggleBlockVisibility("${wrapperId}")'>顯示${label}</button>`;
    }

    // ===== Schrodinger picture data/functions from prototype.html =====
    const schGates = [
      {row:0, col:1, type:'I', color:'#c9b18a'},
      {row:0, col:2, type:'I', color:'#c9b18a'},
      {row:0, col:3, type:'U', color:'#f24d4d'},
      {row:0, col:4, type:'●', color:'#FFC94A'},
      {row:0, col:5, type:'H', color:'#73C7F3'},
      {row:0, col:6, type:'I', color:'#c9b18a'},
      {row:0, col:7, type:'I', color:'#c9b18a'},
      {row:0, col:8, type:'●', color:'#FFC94A'},
      {row:0, col:9, type:'I', color:'#c9b18a'},

      {row:1, col:1, type:'H', color:'#73C7F3'},
      {row:1, col:2, type:'●', color:'#FFC94A'},
      {row:1, col:3, type:'I', color:'#c9b18a'},
      {row:1, col:4, type:'X', color:'#FFC94A'},
      {row:1, col:5, type:'I', color:'#c9b18a'},
      {row:1, col:6, type:'●', color:'#FFC94A'},
      {row:1, col:7, type:'I', color:'#c9b18a'},
      {row:1, col:8, type:'I', color:'#c9b18a'},
      {row:1, col:9, type:'I', color:'#c9b18a'},

      {row:2, col:1, type:'I', color:'#c9b18a'},
      {row:2, col:2, type:'X', color:'#FFC94A'},
      {row:2, col:3, type:'I', color:'#c9b18a'},
      {row:2, col:4, type:'I', color:'#c9b18a'},
      {row:2, col:5, type:'I', color:'#c9b18a'},
      {row:2, col:6, type:'X', color:'#FFC94A'},
      {row:2, col:7, type:'H', color:'#73C7F3'},
      {row:2, col:8, type:'X', color:'#FFC94A'},
      {row:2, col:9, type:'H', color:'#73C7F3'},
    ];
    const schStates = [
      '\\[|\\psi_0\\rangle = |000\\rangle\\]',
      '\\[|\\psi_1\\rangle = \\frac{1}{\\sqrt{2}}\\left(|000\\rangle +|010\\rangle\\right)\\]',
      '\\[|\\psi_2\\rangle = \\frac{1}{\\sqrt{2}}\\left(|000\\rangle +|011\\rangle\\right)\\]',
      '\\[\\begin{align*}' +'|\\psi_3\\rangle &= \\frac{1}{\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |011\\rangle \\\\ ' +
             '&\\qquad + \\beta |100\\rangle + \\beta |111\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_4\\rangle &= \\frac{1}{\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |011\\rangle \\\\ ' +
             '&\\qquad + \\beta |110\\rangle + \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_5\\rangle &= \\frac{1}{2}\\Big[\\alpha |000\\rangle + \\alpha |100\\rangle + \\alpha |011\\rangle +\\alpha |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |110\\rangle + \\beta |001\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_6\\rangle &= \\frac{1}{2}\\Big[\\alpha |000\\rangle + \\alpha |100\\rangle + \\alpha |010\\rangle +\\alpha |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |011\\rangle - \\beta |111\\rangle + \\beta |001\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_7\\rangle &= \\frac{1}{2\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |001\\rangle + \\alpha |100\\rangle +\\alpha |101\\rangle \\\\ ' +
             '&\\qquad + \\alpha |010\\rangle + \\alpha |011\\rangle + \\alpha |110\\rangle +\\alpha |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |011\\rangle - \\beta |110\\rangle + \\beta |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |000\\rangle - \\beta |001\\rangle - \\beta |100\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_8\\rangle &= \\frac{1}{2\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |001\\rangle + \\alpha |101\\rangle +\\alpha |100\\rangle \\\\ ' +
             '&\\qquad + \\alpha |010\\rangle + \\alpha |011\\rangle + \\alpha |111\\rangle +\\alpha |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |011\\rangle - \\beta |111\\rangle + \\beta |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |000\\rangle - \\beta |001\\rangle - \\beta |101\\rangle - \\beta |100\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[|\\psi_9\\rangle = \\frac{1}{2}\\left(|00\\rangle +|10\\rangle + |01\\rangle +|11\\rangle\\right)\\otimes \\left(\\alpha |0\\rangle +\\beta |1\\rangle\\right)\\]',
    ];
    const psiInfo = [
      'Ψ₀', 'Ψ₁', 'Ψ₂', 'Ψ₃', 'Ψ₄', 'Ψ₅', 'Ψ₆', 'Ψ₇', 'Ψ₈', 'Ψ₉'
    ];
    const UInfo = [
      'U₀', 'U₁', 'U₂', 'U₃', 'U₄', 'U₅', 'U₆', 'U₇', 'U₈', 'U₉'
    ];
    function colorAlphaBeta(latex) {
      return latex
        .replace(/\\alpha/g, '{\\color{red}{\\alpha}}')
        .replace(/\\beta/g, '{\\color{red}{\\beta}}');
    }
    function initGridSch() {
      const grid = document.getElementById('grid-sch');
      if (!grid) return;
      grid.innerHTML = '';
      let lookup = {};
      schGates.forEach(g=>{ lookup[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 4; row++) {
        for (let col = 0; col < 11; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `grid-sch-r${row}c${col}`;
          if (row === 3) {
            cell.classList.add('invisible-cell');
          } else {
            if (col === 0) cell.textContent = '|0⟩';
            if (lookup[`${row},${col}`]) {
              cell.textContent = lookup[`${row},${col}`].type;
              cell.classList.add('gate');
              cell.dataset.color = lookup[`${row},${col}`].color;
              cell.style.background = lookup[`${row},${col}`].color;
              cell.style.color = '#222';
              cell.style.opacity = '1';
            }
            if (col === 10) cell.classList.add('invisible-cell');
          }
          grid.appendChild(cell);
        }
      }
      // 記錄每個 col 的 left 位置（以第一 row 為準）
      window.gridCellLefts = [];
      for (let col = 0; col < 11; col++) {
        const cell = document.getElementById(`grid-sch-r0c${col}`);
        if (cell) {
          window.gridCellLefts[col] = cell.offsetLeft;
        }
      }
    }
    function updateSchrodingerGrid(t) {
      // grid highlight
      for (let row = 0; row < 4; row++) {
        for (let col = 0; col < 11; col++) {
          let sch = document.getElementById(`grid-sch-r${row}c${col}`);
          if (sch && sch.classList.contains('gate')) {
            if (col === t && sch.textContent !== 'I') {
              sch.classList.add('highlight');
              sch.style.background = sch.dataset.color;
              sch.style.color = '#fff';
            } else {
              sch.classList.remove('highlight');
              sch.style.background = sch.dataset.color;
              sch.style.color = '#222';
            }
          }
        }
      }
      // 控制底下那一行（row=3）cell的顯示
      for (let col = 0; col < 11; col++) {
        let cell = document.getElementById(`grid-sch-r3c${col}`);
        if (!cell) continue;
        if (col === t) {
          cell.classList.remove('invisible-cell');
          cell.textContent = psiInfo[t] || '';
          cell.style.background = '#2166c2';
          cell.style.color = '#fff';
          cell.style.opacity = '1';
          cell.style.fontWeight = 'bold';
        } else {
          cell.classList.add('invisible-cell');
          cell.textContent = '';
          cell.style.background = '';
          cell.style.color = '';
          cell.style.opacity = '';
          cell.style.fontWeight = '';
        }
      }
    }
    function initGridHei() {
      const grid = document.getElementById('grid-hei');
      if (!grid) return;
      grid.innerHTML = '';
      let lookup = {};
      schGates.forEach(g=>{ lookup[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 4; row++) {
        for (let col = 0; col < 11; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `grid-hei-r${row}c${col}`;
          if (row === 3) {
            cell.classList.add('invisible-cell');
          } else {
            if (col === 0) cell.textContent = '|0⟩';
            if (col === 10) cell.classList.add('invisible-cell');
          }
          grid.appendChild(cell);
        }
      }
    }
    function updateHeisenbergGrid(t) {
      let gateMap = {};
      schGates.forEach(g => { gateMap[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 11; col++) {
          let hei = document.getElementById(`grid-hei-r${row}c${col}`);
          if (!hei) continue;
          if (col === 0 || col === 10) {
            hei.textContent = '|0⟩';
            hei.style.background = '#222';
            hei.style.color = '#c9b18a';
            hei.style.opacity = 1;
            hei.classList.remove('highlight');
          } else if (gateMap[`${row},${col}`]) {
            if (col <= t) {
              hei.textContent = gateMap[`${row},${col}`].type;
              hei.classList.add('gate');
              hei.style.background = gateMap[`${row},${col}`].color;
              hei.style.color = '#fff';
              hei.style.opacity = 1;
              // t 以前（含 t）的 cell 都加 highlight
              hei.classList.add('highlight');
            } else {
              hei.textContent = '';
              hei.classList.remove('gate');
              hei.classList.remove('highlight');
              hei.style.background = '#222';
              hei.style.color = '#222';
              hei.style.opacity = 1;
            }
          } else {
            hei.textContent = '';
            hei.classList.remove('highlight');
            hei.style.background = '#222';
            hei.style.color = '#222';
            hei.style.opacity = 1;
          }
        }
      }
      // 控制底下那一行（row=3）cell的顯示
      for (let col = 0; col < 11; col++) {
        let cell = document.getElementById(`grid-hei-r3c${col}`);
        if (!cell) continue;
        if (col === t) {
          cell.classList.remove('invisible-cell');
          cell.textContent = UInfo[t] || '';
          cell.classList.add('active-ut');
        } else {
          cell.classList.add('invisible-cell');
          cell.textContent = '';
          cell.classList.remove('active-ut');
        }
      }
    }
    // --- Pauli expectation 移植 ---
    const pauliExpectationData = [
      { q1: "(0,1)", q2: "(0,1)", q3: "(0,1)" },//t=0
      { q1: "(0,1)", q2: "(1,0)", q3: "(0,1)" },//t=1
      { q1: "(0,1)", q2: "(0,0)", q3: "(0,0)" },//t=2
      { q1: "(2αβ,α²-β²)", q2: "(0,0)", q3: "(0,0)" },//t=3
      { q1: "(0,α²-β²)", q2: "(0,0)", q3: "(0,0)" },//t=4
      { q1: "(α²-β²,0)", q2: "(0,0)", q3: "(0,0)" },//t=5
      { q1: "(α²-β²,0)", q2: "(1,0)", q3: "(0,α²-β²)" },//t=6
      { q1: "(α²-β²,0)", q2: "(1,0)", q3: "(α²-β²,0)" },//t=7
      { q1: "(1,0)", q2: "(1,0)", q3: "(α²-β²,2αβ)" },//t=8
      { q1: "(1,0)", q2: "(1,0)", q3: "(2αβ,α²-β²)" },//t=9
    ];
    function pauliValToColor(val) {
      if (!isNaN(val)) {
        val = parseFloat(val);
        const strength = Math.min(1, Math.abs(val));
        if (val > 0) return `rgba(115, 199, 243, ${strength})`;  // 藍
        if (val < 0) return `rgba(242, 77, 77, ${strength})`;    // 紅
      }
      if (typeof val === 'string') {
        if (val.includes('α') || val.includes('β')) {
          return '#f24d4d';  // 紅色代表含有 α² - β² 等
        }
      }
      return "#222";  // 非數值則用深色背景
    }
    function pauliFormat(val) {
      if (!isNaN(val)) {
        val = parseFloat(val);
        return (val >= 0 ? '+' : '') + val.toFixed(2);
      }
      return val;
    }
    function extractPair(val) {
      if (typeof val === 'string' && val.startsWith('(')) {
        const [left, right] = val.replace(/[()]/g, '').split(',');
        return [left, right];
      }
      return [val, val];
    }
    function updatePauliExpectation(t) {
      const expect = pauliExpectationData[t] || {q1: 0, q2: 0, q3: 0};
      ['q1', 'q2', 'q3'].forEach((q, i) => {
        const [left, right] = extractPair(expect[q]);
        document.getElementById(`pauli-q${i+1}-left`).textContent = pauliFormat(left);
        document.getElementById(`pauli-q${i+1}-right`).textContent = pauliFormat(right);
        document.getElementById(`pauli-q${i+1}-left`).style.background = pauliValToColor(left);
        document.getElementById(`pauli-q${i+1}-right`).style.background = pauliValToColor(right);
      });
    }
  </script>
</body>
</html>
