<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quantum Teleportation Visualization</title>
  <style>
    html, body {
      margin: 0; padding: 0; width: 100vw; min-height: 100vh; background: #111; color: #c9b18a;
      font-family: 'Fira Mono', monospace;
    }
    .container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 32px;
      padding: 24px;
      width: 100vw;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .main-pictures {
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-width: 380px;
      max-width: 620px;
      flex: 0 1 auto;
    }
    .state-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-width: 340px;
      max-width: 440px;
      flex: 0 1 auto;
      align-items: flex-start;
    }
    .block {
      background: #181818;
      border: 1.5px solid #323232;
      border-radius: 12px;
      margin-bottom: 0px;
      position: relative;
      min-width: 440px;
      max-width: 620px;
      min-height: 120px;
      padding: 18px 24px 24px 24px;
      box-shadow: 0 0 14px #0006;
      transition: opacity 0.25s;
    }
    .block.hide { opacity: 0.05; }
    .block-title {
      font-weight: bold;
      font-size: 1.05rem;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    .hide-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      background: #222;
      border: none;
      border-radius: 5px;
      color: #c9b18a;
      padding: 2px 8px;
      font-size: 1.1em;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .hide-btn:hover { opacity: 1; }
    .grid {
      display: grid;
      grid-template-columns: repeat(11, 32px);
      grid-template-rows: repeat(3, 32px);
      gap: 5px;
      margin-bottom: 8px;
    }
    .cell {
      width: 32px; height: 32px;
      background: #222;
      border: 1px solid #39382c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25em;
      transition: background 0.2s, color 0.2s, opacity 0.2s;
      color: #c9b18a;
      opacity: 0.25;
    }
    .cell.gate { opacity: 1; color: #222; font-weight: bold; }
    .cell.gate.highlight {
      box-shadow: 0 0 10px 2px #fff7, 0 0 0 2px #fff6 inset;
      color: #fff;
      z-index: 2;
      font-size: 1.28em;
    }
    .cell.active {
      background: #6f5b3e;
      color: #fff7c9;
      opacity: 1;
      font-weight: bold;
    }
    .bar-container {
      width: 900px;
      margin: 32px 28px 0 28px;
      padding: 16px 0 0 0;
      position: relative;
      user-select: none;
    }
    .slider-label { color: #c9b18a; margin-bottom: 4px; font-size: 1.04em; }
    .slider {
      width: 100%;
      display: block;
      height: 5px;
      background: #333;
      border-radius: 6px;
      outline: none;
      margin-bottom: 8px;
      -webkit-appearance: none;
      appearance: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 12px;
      border-radius: 2px;
      background: #73C7F3;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px #0003;
      cursor: pointer;
      transition: background 0.2s;
    }
    .slider:focus::-webkit-slider-thumb {
      background: #2981b2;
    }
    .slider::-moz-range-thumb {
      width: 28px;
      height: 12px;
      border-radius: 2px;
      background: #73C7F3;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px #0003;
      cursor: pointer;
      transition: background 0.2s;
    }
    .slider:focus::-moz-range-thumb {
      background: #2981b2;
    }
    .slider::-ms-thumb {
      width: 28px;
      height: 12px;
      border-radius: 2px;
      background: #73C7F3;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px #0003;
      cursor: pointer;
      transition: background 0.2s;
    }
    .slider:focus::-ms-thumb {
      background: #2981b2;
    }
    .slider::-moz-focus-outer {
      border: 0;
    }
    .slider::-ms-fill-lower {
      background: transparent;
    }
    .slider::-ms-fill-upper {
      background: transparent;
    }
    .slider::-webkit-slider-runnable-track {
      height: 5px;
      background: #333;
      border-radius: 6px;
    }
    .slider::-ms-tooltip {
      display: none;
    }
    .slider:focus {
      outline: none;
    }
    .slider-ticks {
      position: absolute;
      left: 0; right: 0; top: 32px;
      height: 12px;
      width: 100%;
      pointer-events: none;
      display: flex;
      justify-content: space-between;
      z-index: 2;
    }
    .slider-ticks .tick {
      width: 2px;
      height: 12px;
      background: #fff;
      opacity: 0.8;
      border-radius: 1px;
    }
    .state-block {
      background: #181818;
      border: 1.5px solid #2981b2;
      border-radius: 12px;
      width: 100%;
      min-width: 230px;
      max-width: 435px;
      max-height: 210px;
      height: 180px;
      box-shadow: 0 0 14px #003a;
      padding: 18px 24px 24px 24px;
      position: relative;
      transition: opacity 0.25s;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      word-break: break-all;
      overflow: hidden;
      margin-left: 0;
      margin-right: 0;
    }
    #state-sch {
      min-height: 2em;
      color: #6fd8fc;
      margin-bottom: 6px;
      font-size: 0.8em;
      font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
      line-height: 1.6;
      word-break: break-word;
      overflow-y: auto;
      overflow-x: auto;
      height: 100%;
      padding-right: 8px;
    }
    /* Descriptor 非latex內容 */
    #descriptor-sch {
      min-height: 2em;
      margin-bottom: 6px;
      font-size: 1em;
      font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
      line-height: 1.7;
      overflow-y: auto;
      overflow-x: auto;
      height: 100%;
      padding-right: 8px;
      color: #e6e6e6;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 2px;
      text-align: center;
    }
    .desc-state-row {
      font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
      font-size: 1.12em;
      color: #f8f8e8;
      margin-bottom: 4px;
      line-height: 1.8;
      padding-left: 3px;
      justify-content: center;
      align-items: center;
      display: flex;
      width: 100%;
    }
    .desc-label2 {
      color: #9fdcf9;
      font-weight: bold;
      margin-right: 2px;
      letter-spacing: .5px;
      font-size: 1.05em;
    }
    .desc-equal {
      color: #eee0a2;
      margin: 0 7px 0 3px;
      font-weight: bold;
    }
    .desc-op {
      font-weight: bold;
      margin-right: 5px;
      display: inline-block;
      text-align: center;
    }
    .desc-s1 { color: gold; }
    .desc-s2 { color: deepskyblue; }
    .desc-s3 { color: magenta; }
    .desc-s4 { color: red; }
    .desc-comma {
      color: #a8a8a8;
      margin: 0 6px 0 2px;
      font-weight: bold;
    }
    .outcome-block {
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      min-width: 100px;
      max-width: 120px;
      margin-left: 24px;
      background: #181818;
      border: 1.5px solid #323232;
      border-radius: 12px;
      box-shadow: 0 0 10px #0007;
      padding: 12px 18px;
      height: 440px;
      position: relative;
      max-width: 180px;
      min-width: 100px;
      width: auto;
      align-self: flex-start;
    }
    .outcome-title {
      margin-bottom: 12px;
      flex-shrink: ;
      font-size: 1.1em;
      font-style: italic;
      margin-bottom: 16px;
      color: #c9b18a;
    }
    .outcome-row {
      display: flex;
      align-items: center;
      margin-bottom: 58px;
      gap: 10px;
    }
    .outcome-label { width: 18px; font-size: 1.12em; }
    .outcome-box {
        width: 100px;
         height: 30px;
         border: 1px solid #39382c;
         border-radius: 5px;
         background: #222;
         display: flex;
         align-items: center;
         justify-content: center;
         color: #fff;
         font-weight: bold;
         font-size: 0.9em;
    }
    .picture-info {
      margin-top: 10px;
      background: #232323;
      border-radius: 8px;
      padding: 10px 16px;
      color: #b6e0ff;
      font-size: 1.08em;
      min-height: 32px;
      text-align: center;
      box-shadow: 0 0 6px #0004;
      border: 1px solid #2981b2;
      transition: margin-left 0.3s;
    }
    .mini-cell-label {
      position: relative;
      height: 36px;
      margin-top: 6px;
      margin-left: 0;
    }
    .mini-cell {
      width: 32px;
      height: 32px;
      background: #222;
      border: 1px solid #39382c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.15em;
      color: #c9b18a;
      font-weight: bold;
      position: absolute;
      top: 0;
      left: 32px;
      transition: left 0.3s;
    }
    .mini-arrow {
      color: #c9b18a;
      font-size: 1em;
      margin-left: 2px;
      font-family: 'Fira Mono', monospace;
    }
    .invisible-cell {
      visibility: hidden;
    }
    .block-content.hide {
      display: none;
    }

    @media (max-width: 1200px) {
      .container {
        gap: 18px;
      }
      .main-pictures {
        min-width: 340px;
        max-width: 98vw;
      }
      .state-column, .outcome-block {
        min-width: 0;
        max-width: 98vw;
      }
      .state-block { min-width: 0; max-width: 98vw; }
    }
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        align-items: center;
        gap: 18px;
        padding: 8px;
      }
      .main-pictures,
      .state-column,
      .outcome-block {
        min-width: 0;
        max-width: 98vw;
        width: 100%;
      }
      .outcome-block {
        margin-left: 0 !important;
        margin-top: 20px;
      }
      .state-block,
      .block,
      .bar-container {
        max-width: 98vw;
        min-width: 0;
      }
    }
    .block-blue, .state-block.block-blue {
      border-color: #2981b2 !important;
      box-shadow: 0 0 14px #0099ff25;
    }
    .block-green, .state-block.block-green {
       border-color: #40e57b !important;
       box-shadow: 0 0 14px #00e08033;
    }
    #block-sch, #block-hei {
      min-height: 185px;
    }
    @media (max-width: 600px) {
      .container {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
        padding: 4px !important;
      }
      .main-pictures,
      .state-column,
      .outcome-block {
        width: 100vw !important;
        max-width: 100vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box;
      }
      .block,
      .state-block,
      .bar-container {
        width: 100vw !important;
        max-width: 100vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        padding: 0 2px !important;
        box-sizing: border-box;
      }
      .outcome-block {
        margin-top: 8px !important;
        margin-left: 0 !important;
        padding: 8px 2px !important;
      }
      .grid {
        grid-template-columns: repeat(11, 22px);
        grid-template-rows: repeat(3, 22px);
        gap: 2px;
        overflow-x: auto;
      }
      .cell {
        width: 22px;
        height: 22px;
        font-size: 0.9em;
      }
      .mini-cell {
        width: 22px;
        height: 22px;
        font-size: 0.8em;
      }
      .bar-container {
        width: 100vw !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        margin: 8px 0 0 0;
        padding: 8px 0 0 0;
      }
      .slider-ticks {
        top: 22px;
      }
      .outcome-row {
        margin-bottom: 18px;
      }
      .outcome-box {
        width: 60px;
        height: 22px;
        font-size: 0.8em;
      }
      .block-title {
        font-size: 0.98rem;
      }
      #state-sch, #descriptor-sch {
        font-size: 0.75em;
        padding-right: 2px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <div class="container">
    <div class="main-pictures">
      <div class="block block-blue" id="block-sch">
        <button class="hide-btn" onclick="toggleBlock('block-sch')">&#9660;</button>
        <div class="block-title">Schrödinger picture</div>
        <div class="block-content">
          <div class="grid" id="grid-sch"></div>
          <div class="mini-cell-label">
            <div class="mini-cell" id="mini-psi"></div>
          </div>
        </div>
      </div>
      <div class="block block-green" id="block-hei">
        <button class="hide-btn" onclick="toggleBlock('block-hei')">&#9660;</button>
        <div class="block-title">Heisenberg picture</div>
        <div class="block-content">
          <div class="grid" id="grid-hei"></div>
          <div class="mini-cell-label">
            <div class="mini-cell" id="mini-u"></div>
          </div>
        </div>
      </div>
      <div class="bar-container">
        <div class="slider-label">t = <span id="time-label">0</span></div>
        <input type="range" min="0" max="9" value="0" class="slider" id="time-slider" />
        <div class="slider-ticks"></div>
      </div>
    </div>
    <div class="state-column">
      <div class="state-block block-blue" id="block-state">
        <button class="hide-btn" onclick="toggleBlock('block-state')">&#9660;</button>
        <div class="block-title">Quantum State</div>
        <div class="block-content">
          <div id="state-sch"></div>
        </div>
      </div>
      <div class="state-block block-green" id="block-descriptor">
        <button class="hide-btn" onclick="toggleBlock('block-descriptor')">&#9660;</button>
        <div class="block-title">Descriptors</div>
        <div class="block-content">
          <div id="descriptor-sch"></div>
        </div>
      </div>
    </div>
    <div class="outcome-block" id="block-outcome">
      <button class="hide-btn" onclick="toggleBlock('block-outcome')">&#9660;</button>
      <div class="outcome-title">expectational value of Pauli (X,Z)</div>
      <div class="block-content">
        <div class="outcome-row"><span class="outcome-label">Q₁</span><div class="outcome-box" id="q1"></div></div>
        <div class="outcome-row"><span class="outcome-label">Q₂</span><div class="outcome-box" id="q2"></div></div>
        <div class="outcome-row"><span class="outcome-label">Q₃</span><div class="outcome-box" id="q3"></div></div>
      </div>
    </div>
  </div>
  <script>
    // 門分布數據
    const schGates = [
      {row:0, col:1, type:'I', color:'#6f5b3e'},
      {row:0, col:2, type:'I', color:'#6f5b3e'},
      {row:0, col:3, type:'U', color:'#f24d4d'},
      {row:0, col:4, type:'●', color:'#FFC94A'},
      {row:0, col:5, type:'H', color:'#73C7F3'},
      {row:0, col:6, type:'I', color:'#6f5b3e'},
      {row:0, col:7, type:'I', color:'#6f5b3e'},
      {row:0, col:8, type:'●', color:'#FFC94A'},
      {row:0, col:9, type:'I', color:'#6f5b3e'},

      {row:1, col:1, type:'H', color:'#73C7F3'},
      {row:1, col:2, type:'●', color:'#FFC94A'},
      {row:1, col:3, type:'I', color:'#6f5b3e'},
      {row:1, col:4, type:'X', color:'#FFC94A'},
      {row:1, col:5, type:'I', color:'#6f5b3e'},
      {row:1, col:6, type:'●', color:'#FFC94A'},
      {row:1, col:7, type:'I', color:'#6f5b3e'},
      {row:1, col:8, type:'I', color:'#6f5b3e'},
      {row:1, col:9, type:'I', color:'#6f5b3e'},

      {row:2, col:1, type:'I', color:'#6f5b3e'},
      {row:2, col:2, type:'X', color:'#FFC94A'},
      {row:2, col:3, type:'I', color:'#6f5b3e'},
      {row:2, col:4, type:'I', color:'#6f5b3e'},
      {row:2, col:5, type:'I', color:'#6f5b3e'},
      {row:2, col:6, type:'X', color:'#FFC94A'},
      {row:2, col:7, type:'H', color:'#73C7F3'},
      {row:2, col:8, type:'X', color:'#FFC94A'},
      {row:2, col:9, type:'H', color:'#73C7F3'},
    ];

    // Quantum state latex
    const schStates = [
      '\\[|\\psi_0\\rangle = |000\\rangle\\]',
      '\\[|\\psi_1\\rangle = \\frac{1}{\\sqrt{2}}\\left(|000\\rangle +|010\\rangle\\right)\\]',
      '\\[|\\psi_2\\rangle = \\frac{1}{\\sqrt{2}}\\left(|000\\rangle +|011\\rangle\\right)\\]',
      '\\[\\begin{align*}' +'|\\psi_3\\rangle &= \\frac{1}{\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |011\\rangle \\\\ ' +
             '&\\qquad + \\beta |100\\rangle + \\beta |111\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_4\\rangle &= \\frac{1}{\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |011\\rangle \\\\ ' +
             '&\\qquad + \\beta |110\\rangle + \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_5\\rangle &= \\frac{1}{2}\\Big[\\alpha |000\\rangle + \\alpha |100\\rangle + \\alpha |011\\rangle +\\alpha |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |110\\rangle + \\beta |001\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_6\\rangle &= \\frac{1}{2}\\Big[\\alpha |000\\rangle + \\alpha |100\\rangle + \\alpha |010\\rangle +\\alpha |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |011\\rangle - \\beta |111\\rangle + \\beta |001\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_7\\rangle &= \\frac{1}{2\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |001\\rangle + \\alpha |100\\rangle +\\alpha |101\\rangle \\\\ ' +
             '&\\qquad + \\alpha |010\\rangle + \\alpha |011\\rangle + \\alpha |110\\rangle +\\alpha |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |011\\rangle - \\beta |110\\rangle + \\beta |111\\rangle \\\\ ' +
             '&\\qquad + \\beta |000\\rangle - \\beta |001\\rangle - \\beta |100\\rangle - \\beta |101\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[\\begin{align*}' +'|\\psi_8\\rangle &= \\frac{1}{2\\sqrt{2}}\\Big[\\alpha |000\\rangle + \\alpha |001\\rangle + \\alpha |101\\rangle +\\alpha |100\\rangle \\\\ ' +
             '&\\qquad + \\alpha |010\\rangle + \\alpha |011\\rangle + \\alpha |111\\rangle +\\alpha |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |010\\rangle - \\beta |011\\rangle - \\beta |111\\rangle + \\beta |110\\rangle \\\\ ' +
             '&\\qquad + \\beta |000\\rangle - \\beta |001\\rangle - \\beta |101\\rangle - \\beta |100\\rangle\\Big]' + '\\end{align*}\\]',
      '\\[|\\psi_9\\rangle = \\frac{1}{2}\\left(|00\\rangle +|10\\rangle + |01\\rangle +|11\\rangle\\right)\\otimes \\left(\\alpha |0\\rangle +\\beta |1\\rangle\\right)\\]',
    ];

    // 非latex顯示descriptor
    const descriptorData = [
      //t=0
  [
    { label: 'Q₁(0)', ops: [
      { text: 'σ₁x', class: 'desc-s1' }, 
      { text: ',', class: 'desc-comma' }, { text: 'σ₁z', class: 'desc-s1' }
    ]},
    { label: 'Q₂(0)', ops: [
      { text: 'σ₂x', class: 'desc-s2' }, 
      { text: ',', class: 'desc-comma' }, { text: 'σ₂z', class: 'desc-s2' }
    ]},
    { label: 'Q₃(0)', ops: [
      { text: 'σ₃x', class: 'desc-s3' }, 
      { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }
    ]}
  ],
  // t=1
  [
    { label: 'Q₁(1)', ops: [
      { text: 'σ₁x', class: 'desc-s1' }, 
      { text: ',', class: 'desc-comma' }, { text: 'σ₁z', class: 'desc-s1' }
    ]},
    { label: 'Q₂(1)', ops: [
      { text: 'σ₂z', class: 'desc-s2' }, 
      { text: ',', class: 'desc-comma' }, { text: 'σ₂x', class: 'desc-s2' }
    ]},
    { label: 'Q₃(1)', ops: [
      { text: 'σ₃x', class: 'desc-s3' }, 
      { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }
    ]}
  ],
  // t=2
  [
   { label: 'Q₁(2)', ops: [
      { text: 'σ₁x', class: 'desc-s1' }, 
      { text: ',', class: 'desc-comma' }, { text: 'σ₁z', class: 'desc-s1' }
    ]},
   { label: 'Q₂(2)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
     { text: ',', class: 'desc-comma' },{ text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(2)', ops: [
     { text: 'σ₃x', class: 'desc-s3' }, 
     { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
   ]}
  ],
  //t=3
  [
   { label: 'Q₁(3)', ops: [
      { text: 'D₁x', class: 'desc-s4' }, 
      { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }
    ]},
   { label: 'Q₂(3)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
     { text: ',', class: 'desc-comma' },{ text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(3)', ops: [
     { text: 'σ₃x', class: 'desc-s3' }, 
     { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
   ]}
  ],
  //t=4
  [
   { label: 'Q₁(4)', ops: [
      { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
      { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }
    ]},
   { label: 'Q₂(4)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
     { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(4)', ops: [
     { text: 'σ₃x', class: 'desc-s3' }, 
     { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
   ]}
  ],
  //t=5
  [
   { label: 'Q₁(5)', ops: [
   { text: 'D₁z', class: 'desc-s4' },
      { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
    ]},
   { label: 'Q₂(5)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' },
     { text: ',', class: 'desc-comma' }, 
     { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(5)', ops: [
     { text: 'σ₃x', class: 'desc-s3' }, 
     { text: ',', class: 'desc-comma' }, { text: 'σ₃z', class: 'desc-s3' }, { text: 'σ₂x', class: 'desc-s2' }
   ]}
  ],
  //t=6
  [
   { label: 'Q₁(6)', ops: [
   { text: 'D₁z', class: 'desc-s4' },
      { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
    ]},
   { label: 'Q₂(6)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },
     { text: ',', class: 'desc-comma' }, 
     { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(6)', ops: [
     { text: 'σ₃x', class: 'desc-s3' }, 
     { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' },
   ]}
  ],
  //t=7
  [
   { label: 'Q₁(7)', ops: [
   { text: 'D₁z', class: 'desc-s4' },
      { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
    ]},
   { label: 'Q₂(7)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },
     { text: ',', class: 'desc-comma' }, 
     { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(7)', ops: [
   { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' },
     { text: ',', class: 'desc-comma' }, { text: 'σ₃x', class: 'desc-s3' }
   ]}
  ],
  //t=8
  [
   { label: 'Q₁(8)', ops: [
      { text: 'σ₃z', class: 'desc-s3' },
      { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
    ]},
   { label: 'Q₂(8)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },
     { text: ',', class: 'desc-comma' }, 
     { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(8)', ops: [
   { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' },
     { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' }
   ]}
  ],
  //t=9
  [
   { label: 'Q₁(8)', ops: [
      { text: 'σ₃z', class: 'desc-s3' },
      { text: ',', class: 'desc-comma' }, { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },{ text: 'σ₃x', class: 'desc-s3' } 
    ]},
   { label: 'Q₂(8)', ops: [
     { text: 'σ₂z', class: 'desc-s2' },
     { text: ',', class: 'desc-comma' }, 
     { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₂x', class: 'desc-s2' }
   ]},
   { label: 'Q₃(8)', ops: [
     { text: 'D₁x', class: 'desc-s4' }, { text: 'σ₂z', class: 'desc-s2' },
     { text: ',', class: 'desc-comma' }, { text: 'D₁z', class: 'desc-s4' }, { text: 'σ₃z', class: 'desc-s3' }
   ]}
  ],
];
     const expectationData = [
          { q1: "(0,1)", q2: "(0,1)", q3: "(0,1)" },//t=0
          { q1: "(0,1)", q2: "(1,0)", q3: "(0,1)" },//t=1
          { q1: "(0,1)", q2: "(0,0)", q3: "(0,0)" },//t=2
          { q1: "(2αβ,α²-β²)", q2: "(0,0)", q3: "(0,0)" },//t=3
          { q1: "(0,α²-β²)", q2: "(0,0)", q3: "(0,0)" },//t=4
          { q1: "(α²-β²,0)", q2: "(0,0)", q3: "(0,0)" },//t=5
          { q1: "(α²-β²,0)", q2: "(1,0)", q3: "(0,α²-β²)" },//t=6
          { q1: "(α²-β²,0)", q2: "(1,0)", q3: "(α²-β²,0)" },//t=7
          { q1: "(1,0)", q2: "(1,0)", q3: "(α²-β²,2αβ)" },//t=8
          { q1: "(1,0)", q2: "(1,0)", q3: "(2αβ,α²-β²)" },//t=9
     ]

    function colorAlphaBeta(latex) {
      return latex
        .replace(/\\alpha/g, '{\\color{red}{\\alpha}}')
        .replace(/\\beta/g, '{\\color{red}{\\beta}}');
    }

    function renderDescriptor(t) {
      const block = document.getElementById('descriptor-sch');
      block.innerHTML = '';
      const list = descriptorData[t] || [];
      for (let item of list) {
        const row = document.createElement('div');
        row.className = 'desc-state-row';
        // 標籤
        const label = document.createElement('span');
        label.className = 'desc-label2';
        label.textContent = item.label;
        row.appendChild(label);
        // 等號
        const eq = document.createElement('span');
        eq.className = 'desc-equal';
        eq.textContent = '=';
        row.appendChild(eq);
        // 遍歷符號
        item.ops.forEach((op) => {
          const opSpan = document.createElement('span');
          opSpan.className = 'desc-op ' + op.class;
          opSpan.innerHTML = op.text;
          row.appendChild(opSpan);
        });
        block.appendChild(row);
      }
      if (list.length === 0) {
        block.innerHTML = '<span class="desc-label">No descriptor at this step.</span>';
      }
    }

    function initGridSch() {
      const grid = document.getElementById('grid-sch');
      grid.innerHTML = '';
      let lookup = {};
      schGates.forEach(g=>{ lookup[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 11; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `grid-sch-r${row}c${col}`;
          if (col === 0) cell.textContent = '|0⟩';
          if (lookup[`${row},${col}`]) {
            cell.textContent = lookup[`${row},${col}`].type;
            cell.classList.add('gate');
            cell.dataset.color = lookup[`${row},${col}`].color;
            cell.style.background = lookup[`${row},${col}`].color;
            cell.style.color = '#222';
            cell.style.opacity = '1';
          }
          if (col === 10) cell.classList.add('invisible-cell');
          grid.appendChild(cell);
        }
      }
    }
    function initGridHei() {
      const grid = document.getElementById('grid-hei');
      grid.innerHTML = '';
      let lookup = {};
      schGates.forEach(g=>{ lookup[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 11; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `grid-hei-r${row}c${col}`;
          if (col === 0 || col === 10) cell.textContent = '|0⟩';
          grid.appendChild(cell);
        }
      }
    }
    initGridSch();
    initGridHei();

    // 新增：每個t對應的Psi和U
    const psiInfo = [
      'Ψ₀', 'Ψ₁', 'Ψ₂', 'Ψ₃', 'Ψ₄', 'Ψ₅', 'Ψ₆', 'Ψ₇', 'Ψ₈', 'Ψ₉'
    ];
    const uInfo = [
      'U₀', 'U₁', 'U₂', 'U₃', 'U₄', 'U₅', 'U₆', 'U₇', 'U₈', 'U₉'
    ];

    function updateMiniCells(t) {
      const cellWidth = 32 + 5; // cell寬+gap
      const left = t * cellWidth; // t=0時left=0
      document.getElementById('mini-psi').textContent = psiInfo[t] || '';
      document.getElementById('mini-u').textContent = uInfo[t] || '';
      document.getElementById('mini-psi').style.left = left + 'px';
      document.getElementById('mini-u').style.left = left + 'px';
    }

    function updateGrids(t) {
      document.getElementById('state-sch').innerHTML = colorAlphaBeta(schStates[t] || '');
      if (window.MathJax)
        MathJax.typesetPromise([document.getElementById('state-sch')]);
      renderDescriptor(t);

      // 薛定諤 picture: 全部顯示門，只高亮當前步
      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 11; col++) {
          let sch = document.getElementById(`grid-sch-r${row}c${col}`);
          if (sch && sch.classList.contains('gate')) {
            if (col === t && sch.textContent !== 'I') {
              sch.classList.add('highlight');
              sch.style.background = sch.dataset.color;
              sch.style.color = '#fff';
            } else {
              sch.classList.remove('highlight');
              sch.style.background = sch.dataset.color;
              sch.style.color = '#222';
            }
          }
        }
      }
      // Heisenberg picture: t及以前的門才出現
      let gateMap = {};
      schGates.forEach(g => { gateMap[`${g.row},${g.col}`] = g; });
      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 11; col++) {
          let hei = document.getElementById(`grid-hei-r${row}c${col}`);
          if (col === 0 || col === 10) {
            hei.textContent = '|0⟩';
            hei.style.background = '#222';
            hei.style.color = '#c9b18a';
            hei.style.opacity = 1;
          } else if (gateMap[`${row},${col}`]) {
            if (col <= t) {
              hei.textContent = gateMap[`${row},${col}`].type;
              hei.classList.add('gate');
              hei.style.background = gateMap[`${row},${col}`].color;
              hei.style.color = '#fff';
              hei.style.opacity = 1;
            } else {
              hei.textContent = '';
              hei.classList.remove('gate');
              hei.style.background = '#222';
              hei.style.color = '#222';
              hei.style.opacity = 1;
            }
          } else {
            hei.textContent = '';
            hei.style.background = '#222';
            hei.style.color = '#222';
            hei.style.opacity = 1;
          }
        }
      }
      // expectation 顯示區更新
      const expect = expectationData[t] || {q1: 0, q2: 0, q3: 0};
      function format(val) {
        if (!isNaN(val)) {
          val = parseFloat(val);
          return (val >= 0 ? '+' : '') + val.toFixed(2);
        }
        return val;  // 若非數字，直接輸出原樣（例如 α²−β²）
      }
      function valToColor(val) {
        if (!isNaN(val)) {
          val = parseFloat(val);
          const strength = Math.min(1, Math.abs(val));
          if (val > 0) return `rgba(115, 199, 243, ${strength})`;  // 藍
          if (val < 0) return `rgba(242, 77, 77, ${strength})`;    // 紅
        }
        if (typeof val === 'string') {
            if (val.includes('α') || val.includes('β')) {
              return '#f24d4d';  // ❗紅色代表含有 α² - β² 等
            }
          }
        return "#222";  // 非數值則用深色背景
      }
      document.getElementById('q1').textContent = format(expect.q1);
      document.getElementById('q2').textContent = format(expect.q2); 
      document.getElementById('q3').textContent = format(expect.q3);
      document.getElementById('q1').style.background = valToColor(expect.q1);
      document.getElementById('q2').style.background = valToColor(expect.q2);
      document.getElementById('q3').style.background = valToColor(expect.q3);
      document.getElementById('time-label').textContent = t;
      updateMiniCells(t);
    }
    document.getElementById('time-slider').addEventListener('input', function() {
      let t = parseInt(this.value);
      updateGrids(t);
    });
    function toggleBlock(id) {
      const block = document.getElementById(id);
      if (!block) return;
      const content = block.querySelector('.block-content');
      if (!content) return;
      content.classList.toggle('hide');
      // 切換倒三角/右三角
      const btn = block.querySelector('.hide-btn');
      if (btn) btn.innerHTML = content.classList.contains('hide') ? '&#9654;' : '&#9660;';
    }
    function setExpectation(q1Color, q2Color, q3Color, q1Text, q2Text, q3Text){
      const q1=document.getElementById('q1');
      const q2=document.getElementById('q2');
      const q3=document.getElementById('q3');
      q1.style.background = q1Color;
      q2.style.background = q2Color;
      q3.style.background = q3Color;
      q1.innerText = q1Text || '';
      q2.innerText = q2Text || '';
      q3.innerText = q3Text || '';
    }
    setExpectation('#73C7F3', '#FFC94A', '#6f5b3e', '+1', '-1', '0');
    updateGrids(0);
    function renderSliderTicks() {
      const ticks = document.querySelector('.slider-ticks');
      ticks.innerHTML = '';
      for (let i = 0; i < 10; i++) {
        const div = document.createElement('div');
        div.className = 'tick';
        ticks.appendChild(div);
      }
    }
    renderSliderTicks();
  </script>
</body>
</html>